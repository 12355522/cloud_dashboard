{{!-- 感測器警報配置管理頁面 --}}

<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h1>
                    <i class="fas fa-exclamation-triangle me-2"></i>感測器警報配置
                </h1>
                <p class="text-muted mb-0">設定感測器數值的警告、危險和臨界閾值</p>
            </div>
            <div>
                <button id="test-alert-btn" class="btn btn-warning me-2">
                    <i class="fas fa-play me-1"></i>測試警報
                </button>
                <a href="/" class="btn btn-secondary">
                    <i class="fas fa-arrow-left me-1"></i>返回儀表板
                </a>
            </div>
        </div>
    </div>
</div>

<!-- 警報配置說明 -->
<div class="row mb-4">
    <div class="col-12">
        <div class="alert alert-info">
            <h6><i class="fas fa-info-circle me-2"></i>警報等級說明</h6>
            <div class="row">
                <div class="col-md-3">
                    <span class="badge bg-warning text-dark">警告 (Warning)</span>
                    <small class="d-block text-muted">數值超出正常範圍，需要關注</small>
                </div>
                <div class="col-md-3">
                    <span class="badge bg-danger">危險 (Danger)</span>
                    <small class="d-block text-muted">數值嚴重異常，需要立即處理</small>
                </div>
                <div class="col-md-3">
                    <span class="badge bg-danger">臨界 (Critical)</span>
                    <small class="d-block text-muted">數值極度異常，觸發全螢幕警報</small>
                </div>
                <div class="col-md-3">
                    <span class="badge bg-success">正常 (Normal)</span>
                    <small class="d-block text-muted">數值在正常範圍內</small>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 感測器類型配置 -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-cog me-2"></i>警報閾值配置
                </h5>
            </div>
            <div class="card-body">
                <form id="alert-config-form">
                    <!-- 溫度感測器配置 -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <h6 class="border-bottom pb-2">
                                <i class="fas fa-thermometer-half text-danger me-2"></i>溫度感測器 (°C)
                            </h6>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">正常範圍</label>
                            <div class="input-group">
                                <input type="number" class="form-control" id="temp-normal-min" value="15" step="0.1">
                                <span class="input-group-text">至</span>
                                <input type="number" class="form-control" id="temp-normal-max" value="35" step="0.1">
                            </div>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">警告範圍</label>
                            <div class="input-group">
                                <input type="number" class="form-control" id="temp-warning-min" value="10" step="0.1">
                                <span class="input-group-text">至</span>
                                <input type="number" class="form-control" id="temp-warning-max" value="40" step="0.1">
                            </div>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">危險範圍</label>
                            <div class="input-group">
                                <input type="number" class="form-control" id="temp-danger-min" value="5" step="0.1">
                                <span class="input-group-text">至</span>
                                <input type="number" class="form-control" id="temp-danger-max" value="45" step="0.1">
                            </div>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">臨界範圍</label>
                            <div class="input-group">
                                <input type="number" class="form-control" id="temp-critical-min" value="0" step="0.1">
                                <span class="input-group-text">至</span>
                                <input type="number" class="form-control" id="temp-critical-max" value="50" step="0.1">
                            </div>
                        </div>
                    </div>

                    <!-- 濕度感測器配置 -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <h6 class="border-bottom pb-2">
                                <i class="fas fa-tint text-info me-2"></i>濕度感測器 (%)
                            </h6>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">正常範圍</label>
                            <div class="input-group">
                                <input type="number" class="form-control" id="humidity-normal-min" value="40" step="1">
                                <span class="input-group-text">至</span>
                                <input type="number" class="form-control" id="humidity-normal-max" value="80" step="1">
                            </div>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">警告範圍</label>
                            <div class="input-group">
                                <input type="number" class="form-control" id="humidity-warning-min" value="30" step="1">
                                <span class="input-group-text">至</span>
                                <input type="number" class="form-control" id="humidity-warning-max" value="90" step="1">
                            </div>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">危險範圍</label>
                            <div class="input-group">
                                <input type="number" class="form-control" id="humidity-danger-min" value="20" step="1">
                                <span class="input-group-text">至</span>
                                <input type="number" class="form-control" id="humidity-danger-max" value="95" step="1">
                            </div>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">臨界範圍</label>
                            <div class="input-group">
                                <input type="number" class="form-control" id="humidity-critical-min" value="10" step="1">
                                <span class="input-group-text">至</span>
                                <input type="number" class="form-control" id="humidity-critical-max" value="100" step="1">
                            </div>
                        </div>
                    </div>

                    <!-- CO2感測器配置 -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <h6 class="border-bottom pb-2">
                                <i class="fas fa-cloud text-secondary me-2"></i>CO2感測器 (ppm)
                            </h6>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">正常範圍</label>
                            <div class="input-group">
                                <input type="number" class="form-control" id="co2-normal-min" value="300" step="10">
                                <span class="input-group-text">至</span>
                                <input type="number" class="form-control" id="co2-normal-max" value="1000" step="10">
                            </div>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">警告範圍</label>
                            <div class="input-group">
                                <input type="number" class="form-control" id="co2-warning-min" value="200" step="10">
                                <span class="input-group-text">至</span>
                                <input type="number" class="form-control" id="co2-warning-max" value="1500" step="10">
                            </div>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">危險範圍</label>
                            <div class="input-group">
                                <input type="number" class="form-control" id="co2-danger-min" value="100" step="10">
                                <span class="input-group-text">至</span>
                                <input type="number" class="form-control" id="co2-danger-max" value="2000" step="10">
                            </div>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">臨界範圍</label>
                            <div class="input-group">
                                <input type="number" class="form-control" id="co2-critical-min" value="50" step="10">
                                <span class="input-group-text">至</span>
                                <input type="number" class="form-control" id="co2-critical-max" value="3000" step="10">
                            </div>
                        </div>
                    </div>

                    <!-- 其他感測器配置 -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <h6 class="border-bottom pb-2">
                                <i class="fas fa-wind text-warning me-2"></i>風速感測器 (m/s)
                            </h6>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">正常範圍</label>
                            <div class="input-group">
                                <input type="number" class="form-control" id="wind-normal-min" value="0" step="0.1">
                                <span class="input-group-text">至</span>
                                <input type="number" class="form-control" id="wind-normal-max" value="20" step="0.1">
                            </div>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">警告範圍</label>
                            <div class="input-group">
                                <input type="number" class="form-control" id="wind-warning-min" value="0" step="0.1">
                                <span class="input-group-text">至</span>
                                <input type="number" class="form-control" id="wind-warning-max" value="30" step="0.1">
                            </div>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">危險範圍</label>
                            <div class="input-group">
                                <input type="number" class="form-control" id="wind-danger-min" value="0" step="0.1">
                                <span class="input-group-text">至</span>
                                <input type="number" class="form-control" id="wind-danger-max" value="40" step="0.1">
                            </div>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">臨界範圍</label>
                            <div class="input-group">
                                <input type="number" class="form-control" id="wind-critical-min" value="0" step="0.1">
                                <span class="input-group-text">至</span>
                                <input type="number" class="form-control" id="wind-critical-max" value="50" step="0.1">
                            </div>
                        </div>
                    </div>

                    <!-- 按鈕區域 -->
                    <div class="row">
                        <div class="col-12 text-center">
                            <button type="submit" class="btn btn-primary btn-lg me-3">
                                <i class="fas fa-save me-2"></i>儲存配置
                            </button>
                            <button type="button" id="reset-config-btn" class="btn btn-outline-secondary btn-lg">
                                <i class="fas fa-undo me-2"></i>重置為預設值
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- 警報歷史記錄 -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-history me-2"></i>警報歷史記錄
                </h5>
            </div>
            <div class="card-body">
                <div id="alert-history">
                    <p class="text-muted text-center py-3">尚無警報記錄</p>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // 載入當前配置
    loadCurrentConfig();
    
    // 表單提交事件
    document.getElementById('alert-config-form').addEventListener('submit', function(e) {
        e.preventDefault();
        saveAlertConfig();
    });
    
    // 重置配置按鈕
    document.getElementById('reset-config-btn').addEventListener('click', function() {
        if (confirm('確定要重置為預設配置嗎？')) {
            resetToDefaultConfig();
        }
    });
    
    // 測試警報按鈕
    document.getElementById('test-alert-btn').addEventListener('click', function() {
        if (window.sensorAlertSystem) {
            window.sensorAlertSystem.testAlert();
        } else {
            alert('警報系統未載入，請重新整理頁面');
        }
    });
});

// 載入當前配置
function loadCurrentConfig() {
    if (window.sensorAlertSystem) {
        const config = window.sensorAlertSystem.getAlertConfig();
        
        // 溫度配置
        document.getElementById('temp-normal-min').value = config.temperature.min;
        document.getElementById('temp-normal-max').value = config.temperature.max;
        document.getElementById('temp-warning-min').value = config.temperature.warning.min;
        document.getElementById('temp-warning-max').value = config.temperature.warning.max;
        document.getElementById('temp-danger-min').value = config.temperature.danger.min;
        document.getElementById('temp-danger-max').value = config.temperature.danger.max;
        document.getElementById('temp-critical-min').value = config.temperature.critical.min;
        document.getElementById('temp-critical-max').value = config.temperature.critical.max;
        
        // 濕度配置
        document.getElementById('humidity-normal-min').value = config.humidity.min;
        document.getElementById('humidity-normal-max').value = config.humidity.max;
        document.getElementById('humidity-warning-min').value = config.humidity.warning.min;
        document.getElementById('humidity-warning-max').value = config.humidity.warning.max;
        document.getElementById('humidity-danger-min').value = config.humidity.danger.min;
        document.getElementById('humidity-danger-max').value = config.humidity.danger.max;
        document.getElementById('humidity-critical-min').value = config.humidity.critical.min;
        document.getElementById('humidity-critical-max').value = config.humidity.critical.max;
        
        // CO2配置
        document.getElementById('co2-normal-min').value = config.co2.min;
        document.getElementById('co2-normal-max').value = config.co2.max;
        document.getElementById('co2-warning-min').value = config.co2.warning.min;
        document.getElementById('co2-warning-max').value = config.co2.warning.max;
        document.getElementById('co2-danger-min').value = config.co2.danger.min;
        document.getElementById('co2-danger-max').value = config.co2.danger.max;
        document.getElementById('co2-critical-min').value = config.co2.critical.min;
        document.getElementById('co2-critical-max').value = config.co2.critical.max;
        
        // 風速配置
        document.getElementById('wind-normal-min').value = config.wind.min;
        document.getElementById('wind-normal-max').value = config.wind.max;
        document.getElementById('wind-warning-min').value = config.wind.warning.min;
        document.getElementById('wind-warning-max').value = config.wind.warning.max;
        document.getElementById('wind-danger-min').value = config.wind.danger.min;
        document.getElementById('wind-danger-max').value = config.wind.danger.max;
        document.getElementById('wind-critical-min').value = config.wind.critical.min;
        document.getElementById('wind-critical-max').value = config.wind.critical.max;
    }
}

// 儲存警報配置
function saveAlertConfig() {
    if (!window.sensorAlertSystem) {
        alert('警報系統未載入，請重新整理頁面');
        return;
    }
    
    const newConfig = {
        temperature: {
            min: parseFloat(document.getElementById('temp-normal-min').value),
            max: parseFloat(document.getElementById('temp-normal-max').value),
            warning: {
                min: parseFloat(document.getElementById('temp-warning-min').value),
                max: parseFloat(document.getElementById('temp-warning-max').value)
            },
            danger: {
                min: parseFloat(document.getElementById('temp-danger-min').value),
                max: parseFloat(document.getElementById('temp-danger-max').value)
            },
            critical: {
                min: parseFloat(document.getElementById('temp-critical-min').value),
                max: parseFloat(document.getElementById('temp-critical-max').value)
            }
        },
        humidity: {
            min: parseFloat(document.getElementById('humidity-normal-min').value),
            max: parseFloat(document.getElementById('humidity-normal-max').value),
            warning: {
                min: parseFloat(document.getElementById('humidity-warning-min').value),
                max: parseFloat(document.getElementById('humidity-warning-max').value)
            },
            danger: {
                min: parseFloat(document.getElementById('humidity-danger-min').value),
                max: parseFloat(document.getElementById('humidity-danger-max').value)
            },
            critical: {
                min: parseFloat(document.getElementById('humidity-critical-min').value),
                max: parseFloat(document.getElementById('humidity-critical-max').value)
            }
        },
        co2: {
            min: parseFloat(document.getElementById('co2-normal-min').value),
            max: parseFloat(document.getElementById('co2-normal-max').value),
            warning: {
                min: parseFloat(document.getElementById('co2-warning-min').value),
                max: parseFloat(document.getElementById('co2-warning-max').value)
            },
            danger: {
                min: parseFloat(document.getElementById('co2-danger-min').value),
                max: parseFloat(document.getElementById('co2-danger-max').value)
            },
            critical: {
                min: parseFloat(document.getElementById('co2-critical-min').value),
                max: parseFloat(document.getElementById('co2-critical-max').value)
            }
        },
        wind: {
            min: parseFloat(document.getElementById('wind-normal-min').value),
            max: parseFloat(document.getElementById('wind-normal-max').value),
            warning: {
                min: parseFloat(document.getElementById('wind-warning-min').value),
                max: parseFloat(document.getElementById('wind-warning-max').value)
            },
            danger: {
                min: parseFloat(document.getElementById('wind-danger-min').value),
                max: parseFloat(document.getElementById('wind-danger-max').value)
            },
            critical: {
                min: parseFloat(document.getElementById('wind-critical-min').value),
                max: parseFloat(document.getElementById('wind-critical-max').value)
            }
        }
    };
    
    // 驗證配置
    if (!validateConfig(newConfig)) {
        return;
    }
    
    // 更新配置
    window.sensorAlertSystem.updateAlertConfig(newConfig);
    
    // 儲存到本地儲存
    localStorage.setItem('sensorAlertConfig', JSON.stringify(newConfig));
    
    // 顯示成功訊息
    showNotification('警報配置已儲存', 'success');
}

// 驗證配置
function validateConfig(config) {
    const sensors = ['temperature', 'humidity', 'co2', 'wind'];
    
    for (const sensor of sensors) {
        const sensorConfig = config[sensor];
        
        // 檢查正常範圍
        if (sensorConfig.min >= sensorConfig.max) {
            alert(`${sensor} 感測器的正常範圍設定錯誤：最小值必須小於最大值`);
            return false;
        }
        
        // 檢查警告範圍
        if (sensorConfig.warning.min >= sensorConfig.warning.max) {
            alert(`${sensor} 感測器的警告範圍設定錯誤：最小值必須小於最大值`);
            return false;
        }
        
        // 檢查危險範圍
        if (sensorConfig.danger.min >= sensorConfig.danger.max) {
            alert(`${sensor} 感測器的危險範圍設定錯誤：最小值必須小於最大值`);
            return false;
        }
        
        // 檢查臨界範圍
        if (sensorConfig.critical.min >= sensorConfig.critical.max) {
            alert(`${sensor} 感測器的臨界範圍設定錯誤：最小值必須小於最大值`);
            return false;
        }
        
        // 檢查範圍層級
        if (sensorConfig.warning.min > sensorConfig.min || sensorConfig.warning.max < sensorConfig.max) {
            alert(`${sensor} 感測器的警告範圍必須包含正常範圍`);
            return false;
        }
        
        if (sensorConfig.danger.min > sensorConfig.warning.min || sensorConfig.danger.max < sensorConfig.warning.max) {
            alert(`${sensor} 感測器的危險範圍必須包含警告範圍`);
            return false;
        }
        
        if (sensorConfig.critical.min > sensorConfig.danger.min || sensorConfig.critical.max < sensorConfig.danger.max) {
            alert(`${sensor} 感測器的臨界範圍必須包含危險範圍`);
            return false;
        }
    }
    
    return true;
}

// 重置為預設配置
function resetToDefaultConfig() {
    if (window.sensorAlertSystem) {
        const defaultConfig = window.sensorAlertSystem.getDefaultAlertConfig();
        window.sensorAlertSystem.updateAlertConfig(defaultConfig);
        loadCurrentConfig();
        showNotification('已重置為預設配置', 'info');
    }
}

// 顯示通知
function showNotification(message, type = 'info') {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
    alertDiv.style.top = '20px';
    alertDiv.style.right = '20px';
    alertDiv.style.zIndex = '9999';
    alertDiv.style.minWidth = '300px';
    
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(alertDiv);
    
    // 5秒後自動移除
    setTimeout(() => {
        if (alertDiv.parentNode) {
            alertDiv.remove();
        }
    }, 5000);
}
</script>
