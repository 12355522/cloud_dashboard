<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h1>
                    <i class="fas fa-map-marker-alt me-2"></i>{{farm.name}}
                </h1>
                <p class="text-muted mb-0">IP: <code>{{farm.ip}}</code></p>
            </div>
            <div>
                <a href="/farms/{{farm.id}}/edit" class="btn btn-outline-primary me-2">
                    <i class="fas fa-edit me-1"></i>ç·¨è¼¯
                </a>
                <a href="/farms" class="btn btn-secondary">
                    <i class="fas fa-arrow-left me-1"></i>è¿”å›åˆ—è¡¨
                </a>
            </div>
        </div>
    </div>
</div>

<!-- çµ±è¨ˆå¡ç‰‡ -->
<div class="row mb-4">
    <div class="col-lg-3 col-md-6 mb-3">
        <div class="card bg-primary text-white">
            <div class="card-body text-center">
                <i class="fas fa-calendar-alt fa-2x mb-2"></i>
                <h4 class="mb-0">{{farm.stats.feeding_days}}</h4>
                <small>é£¼é¤Šå¤©æ•¸</small>
            </div>
        </div>
    </div>
    
    <div class="col-lg-3 col-md-6 mb-3">
        <div class="card bg-success text-white">
            <div class="card-body text-center">
                <i class="fas fa-feather-alt fa-2x mb-2"></i>
                <h4 class="mb-0">{{farm.stats.animal_count}}</h4>
                <small>é£¼é¤Šæ•¸é‡ (éš»)</small>
            </div>
        </div>
    </div>
    
    <div class="col-lg-3 col-md-6 mb-3">
        <div class="card bg-info text-white">
            <div class="card-body text-center">
                <i class="fas fa-tint fa-2x mb-2"></i>
                <h4 class="mb-0">{{farm.stats.water_consumption}}</h4>
                <small>é£²æ°´é‡ (å…¬å‡)</small>
            </div>
        </div>
    </div>
    
    <div class="col-lg-3 col-md-6 mb-3">
        <div class="card bg-warning text-white">
            <div class="card-body text-center">
                <i class="fas fa-fan fa-2x mb-2"></i>
                <h4 class="mb-0">{{farm.stats.fan_count}}</h4>
                <small>é¢¨æ‰‡æ•¸é‡ (å°)</small>
            </div>
        </div>
    </div>
</div>

<!-- å ´åŸŸä½ˆå±€ç®¡ç† -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-image me-2"></i>å ´åŸŸä½ˆå±€åœ–
                </h5>
            </div>
            <div class="card-body p-0">
                {{#if farm.layout_image}}
                <!-- ä½ˆå±€åœ–å¤–æ¡† -->
                <div class="layout-wrapper">
                    <div class="layout-container-enhanced">
                        <div class="layout-image-container">
                            <img id="layout-image" src="/uploads/{{farm.layout_image}}" alt="å ´åŸŸä½ˆå±€åœ–">
                            
                            <!-- æ„Ÿæ¸¬å™¨å’Œè¨­å‚™æ¨™è¨˜ -->
                            <div id="sensors-container" class="markers-layer">
                                {{#each farm.sensors}}
                                <div class="sensor-marker" style="position: absolute; left: {{this.x}}%; top: {{this.y}}%;" 
                                     data-type="sensor" data-id="{{this.id}}" title="{{this.name}}">
                                    <i class="fas fa-thermometer-half text-primary"></i>
                                </div>
                                {{/each}}
                            </div>
                            
                            <div id="devices-container" class="markers-layer">
                                {{#each farm.devices}}
                                <div class="device-marker" style="position: absolute; left: {{this.x}}%; top: {{this.y}}%;" 
                                     data-type="device" data-id="{{this.id}}" title="{{this.name}}">
                                    <i class="fas fa-fan text-warning"></i>
                                </div>
                                {{/each}}
                            </div>
                            
                            <!-- æ ¼ç·šèƒŒæ™¯ -->
                            <div class="grid-overlay" id="grid-overlay"></div>
                        </div>
                        
                        <!-- ç¸®æ”¾æ§åˆ¶ -->
                        <div class="zoom-controls">
                            <button class="btn btn-sm btn-outline-light" id="zoom-in-btn" title="æ”¾å¤§">
                                <i class="fas fa-search-plus"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-light" id="zoom-out-btn" title="ç¸®å°">
                                <i class="fas fa-search-minus"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-light" id="zoom-reset-btn" title="é‡è¨­">
                                <i class="fas fa-expand-arrows-alt"></i>
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- å·¥å…·åˆ— -->
                <div class="layout-toolbar">
                    <div class="d-flex justify-content-between align-items-center">
                        <div class="btn-group" role="group">
                            <button type="button" class="btn btn-outline-primary" id="edit-mode-btn">
                                <i class="fas fa-edit me-1"></i>ç·¨è¼¯æ¨¡å¼
                            </button>
                            <button type="button" class="btn btn-outline-success" id="add-sensor-btn" disabled>
                                <i class="fas fa-plus me-1"></i>æ–°å¢æ„Ÿæ¸¬å™¨
                            </button>
                            <button type="button" class="btn btn-outline-warning" id="add-device-btn" disabled>
                                <i class="fas fa-plus me-1"></i>æ–°å¢è¨­å‚™
                            </button>
                        </div>
                        <div class="d-flex align-items-center">
                            <button type="button" class="btn btn-success me-3" id="save-layout-btn" style="display: none;">
                                <i class="fas fa-save me-1"></i>å„²å­˜ä½ˆå±€
                            </button>
                            <span class="text-muted small" id="layout-info">
                                <i class="fas fa-info-circle me-1"></i>é»æ“Šç·¨è¼¯æ¨¡å¼é–‹å§‹é…ç½®è¨­å‚™ä½ç½®
                            </span>
                        </div>
                    </div>
                </div>
                {{else}}
                <div class="text-center py-5">
                    <i class="fas fa-upload fa-3x text-muted mb-3"></i>
                    <h5 class="text-muted">å°šæœªä¸Šå‚³å ´åŸŸä½ˆå±€åœ–</h5>
                    <p class="text-muted">è«‹ä¸Šå‚³å ´åŸŸçš„å¹³é¢åœ–ä»¥ä¾¿é€²è¡Œè¨­å‚™å’Œæ„Ÿæ¸¬å™¨çš„é…ç½®</p>
                </div>
                {{/if}}
                
                <!-- ä¸Šå‚³æ–°åœ–ç‰‡ -->
                <form action="/farms/{{farm._id}}/upload-layout" method="post" enctype="multipart/form-data" class="mt-3" id="uploadForm">
                    <div class="input-group">
                        <input type="file" class="form-control" name="layout_image" accept="image/*" required id="layoutImageInput">
                        <button type="button" class="btn btn-primary" id="uploadBtn">
                            <span id="uploadBtnText">
                                <i class="fas fa-upload me-1"></i>{{#if farm.layout_image}}æ›´æ›åœ–ç‰‡{{else}}ä¸Šå‚³åœ–ç‰‡{{/if}}
                            </span>
                            <span id="uploadingText" class="d-none">
                                <i class="fas fa-spinner fa-spin me-1"></i>ä¸Šå‚³ä¸­...
                            </span>
                        </button>
                    </div>
                    <div class="form-text">æ”¯æ´æ ¼å¼ï¼šJPG, PNG, GIF (æœ€å¤§ 5MB)</div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- æ„Ÿæ¸¬å™¨å’Œè¨­å‚™åˆ—è¡¨ -->
<div class="row mt-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0">
                    <i class="fas fa-thermometer-half me-2"></i>æ„Ÿæ¸¬å™¨åˆ—è¡¨
                </h6>
            </div>
            <div class="card-body">
                {{#if farm.sensors}}
                <div class="list-group">
                    {{#each farm.sensors}}
                    <div class="list-group-item d-flex justify-content-between align-items-center">
                        <div>
                            {{#if this.description}}
                            <strong>{{this.description}}</strong>
                            <br>
                            <small class="text-muted">é¡å‹åç¨±: {{this.name}}</small>
                            {{else}}
                            <strong>{{this.name}}</strong>
                            {{/if}}
                            <br>
                            <small class="text-muted">é¡å‹: {{this.type}}</small>
                            {{#if this.deviceName}}
                            <br>
                            <small class="text-muted">è¨­å‚™: {{this.deviceName}}</small>
                            {{/if}}
                        </div>
                        <div class="text-end">
                            <span class="badge {{statusBadge this.status}} rounded-pill mb-1">{{this.status}}</span>
                            <br>
                            <small class="text-muted">{{this.x}}, {{this.y}}</small>
                        </div>
                    </div>
                    {{/each}}
                </div>
                {{else}}
                <p class="text-muted text-center py-3">å°šç„¡æ„Ÿæ¸¬å™¨è³‡æ–™</p>
                {{/if}}
            </div>
        </div>
    </div>
    
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0">
                    <i class="fas fa-fan me-2"></i>è¨­å‚™åˆ—è¡¨
                </h6>
            </div>
            <div class="card-body">
                {{#if farm.devices}}
                <div class="list-group">
                    {{#each farm.devices}}
                    <div class="list-group-item d-flex justify-content-between align-items-center">
                        <div>
                            <strong>{{this.name}}</strong>
                            <br>
                            <small class="text-muted">é¡å‹: {{this.type}}</small>
                            {{#if this.deviceName}}
                            <br>
                            <small class="text-muted">è¨­å‚™: {{this.deviceName}}</small>
                            {{/if}}
                        </div>
                        <div class="text-end">
                            <span class="badge {{statusBadge this.status}} rounded-pill mb-1">{{this.status}}</span>
                            <br>
                            <small class="text-muted">{{this.x}}, {{this.y}}</small>
                        </div>
                    </div>
                    {{/each}}
                </div>
                {{else}}
                <p class="text-muted text-center py-3">å°šç„¡è¨­å‚™è³‡æ–™</p>
                {{/if}}
            </div>
        </div>
    </div>
</div>

<script>
// 2D ä½ˆå±€ç·¨è¼¯åŠŸèƒ½
document.addEventListener('DOMContentLoaded', function() {
    const farmId = '{{farm._id}}';
    let editMode = false;
    let sensors = {{{json farm.sensors}}};
    let devices = {{{json farm.devices}}};
    
    const editModeBtn = document.getElementById('edit-mode-btn');
    const addSensorBtn = document.getElementById('add-sensor-btn');
    const addDeviceBtn = document.getElementById('add-device-btn');
    const saveLayoutBtn = document.getElementById('save-layout-btn');
    const layoutImage = document.getElementById('layout-image');
    
    if (editModeBtn) {
        editModeBtn.addEventListener('click', toggleEditMode);
    }
    
    if (addSensorBtn) {
        addSensorBtn.addEventListener('click', () => addItem('sensor'));
    }
    
    if (addDeviceBtn) {
        addDeviceBtn.addEventListener('click', () => addItem('device'));
    }
    
    if (saveLayoutBtn) {
        saveLayoutBtn.addEventListener('click', saveLayout);
    }
    
    function toggleEditMode() {
        editMode = !editMode;
        const gridOverlay = document.getElementById('grid-overlay');
        const layoutInfo = document.getElementById('layout-info');
        
        if (editMode) {
            editModeBtn.innerHTML = '<i class="fas fa-times me-1"></i>é€€å‡ºç·¨è¼¯';
            editModeBtn.className = 'btn btn-danger';
            addSensorBtn.disabled = false;
            addDeviceBtn.disabled = false;
            saveLayoutBtn.style.display = 'inline-block';
            layoutImage.style.cursor = 'crosshair';
            if (gridOverlay) gridOverlay.classList.add('show');
            if (layoutInfo) {
                layoutInfo.innerHTML = '<i class="fas fa-edit me-1"></i>ç·¨è¼¯æ¨¡å¼ï¼šæ‹–å‹•è¨­å‚™èª¿æ•´ä½ç½®ï¼ŒæŒ‰ä½ Shift éµç¶²æ ¼å°é½Š';
                layoutInfo.style.background = 'rgba(40, 167, 69, 0.1)';
                layoutInfo.style.borderColor = 'rgba(40, 167, 69, 0.2)';
            }
            enableDragging();
        } else {
            editModeBtn.innerHTML = '<i class="fas fa-edit me-1"></i>ç·¨è¼¯æ¨¡å¼';
            editModeBtn.className = 'btn btn-outline-primary';
            addSensorBtn.disabled = true;
            addDeviceBtn.disabled = true;
            saveLayoutBtn.style.display = 'none';
            layoutImage.style.cursor = 'default';
            if (gridOverlay) gridOverlay.classList.remove('show');
            if (layoutInfo) {
                layoutInfo.innerHTML = '<i class="fas fa-info-circle me-1"></i>é»æ“Šç·¨è¼¯æ¨¡å¼é–‹å§‹é…ç½®è¨­å‚™ä½ç½®';
                layoutInfo.style.background = 'rgba(13, 110, 253, 0.1)';
                layoutInfo.style.borderColor = 'rgba(13, 110, 253, 0.2)';
            }
            disableDragging();
        }
    }
    
    function enableDragging() {
        const markers = document.querySelectorAll('.sensor-marker, .device-marker');
        markers.forEach(marker => {
            marker.style.cursor = 'move';
            setupMouseDrag(marker);
        });
    }
    
    function disableDragging() {
        const markers = document.querySelectorAll('.sensor-marker, .device-marker');
        markers.forEach(marker => {
            marker.style.cursor = 'default';
            removeMouseDrag(marker);
        });
    }
    
    let isDragging = false;
    let draggedElement = null;
    let dragOffset = { x: 0, y: 0 };
    
    function setupMouseDrag(element) {
        element.addEventListener('mousedown', handleMouseDown);
    }
    
    function removeMouseDrag(element) {
        element.removeEventListener('mousedown', handleMouseDown);
    }
    
    function handleMouseDown(e) {
        if (!editMode) return;
        
        e.preventDefault();
        e.stopPropagation();
        
        draggedElement = e.currentTarget;
        isDragging = true;
        
        // è¨ˆç®—æ»‘é¼ ç›¸å°æ–¼å…ƒç´ çš„åç§»
        const elementRect = draggedElement.getBoundingClientRect();
        const imageContainer = document.querySelector('.layout-image-container');
        const imageRect = imageContainer.getBoundingClientRect();
        
        dragOffset.x = e.clientX - elementRect.left - elementRect.width / 2;
        dragOffset.y = e.clientY - elementRect.top - elementRect.height / 2;
        
        // æ·»åŠ å…¨åŸŸç›£è½å™¨
        document.addEventListener('mousemove', handleMouseMove);
        document.addEventListener('mouseup', handleMouseUp);
        
        // è¦–è¦ºæ•ˆæœ
        draggedElement.classList.add('dragging');
        const container = document.querySelector('.layout-container-enhanced');
        if (container) container.classList.add('edit-mode');
        
        console.log('ğŸ¯ é–‹å§‹æ‹–æ‹½:', draggedElement.dataset.id);
    }
    
    function handleMouseMove(e) {
        if (!isDragging || !draggedElement) return;
        
        e.preventDefault();
        
        const imageContainer = document.querySelector('.layout-image-container');
        const image = document.getElementById('layout-image');
        
        if (!imageContainer || !image) return;
        
        const containerRect = imageContainer.getBoundingClientRect();
        const imageRect = image.getBoundingClientRect();
        
        // è¨ˆç®—æ»‘é¼ åœ¨åœ–ç‰‡å…§çš„ç›¸å°ä½ç½®ï¼ˆè€ƒæ…®ç¸®æ”¾ï¼‰
        const mouseX = e.clientX - dragOffset.x;
        const mouseY = e.clientY - dragOffset.y;
        
        // è½‰æ›ç‚ºç›¸å°æ–¼å¯¦éš›åœ–ç‰‡çš„åº§æ¨™
        const relativeX = mouseX - imageRect.left;
        const relativeY = mouseY - imageRect.top;
        
        // è½‰æ›ç‚ºç™¾åˆ†æ¯”ï¼ˆç›¸å°æ–¼åœ–ç‰‡å°ºå¯¸ï¼‰
        let percentX = Math.max(0, Math.min(100, (relativeX / imageRect.width) * 100));
        let percentY = Math.max(0, Math.min(100, (relativeY / imageRect.height) * 100));
        
        // ç¶²æ ¼å°é½ŠåŠŸèƒ½ï¼ˆå¯é¸ï¼‰
        const gridSnap = e.shiftKey; // æŒ‰ä½ Shift éµå•Ÿç”¨ç¶²æ ¼å°é½Š
        const gridOverlay = document.getElementById('grid-overlay');
        if (gridSnap) {
            const gridSize = 5; // 5% ç¶²æ ¼
            percentX = Math.round(percentX / gridSize) * gridSize;
            percentY = Math.round(percentY / gridSize) * gridSize;
            if (gridOverlay) gridOverlay.classList.add('snap-mode');
        } else {
            if (gridOverlay) gridOverlay.classList.remove('snap-mode');
        }
        
        // ç«‹å³æ›´æ–°è¦–è¦ºä½ç½®
        draggedElement.style.left = percentX + '%';
        draggedElement.style.top = percentY + '%';
        
        console.log('ğŸ“ æ‹–æ‹½ä½ç½®:', { x: percentX.toFixed(1), y: percentY.toFixed(1) });
    }
    
    function handleMouseUp(e) {
        if (!isDragging || !draggedElement) return;
        
        e.preventDefault();
        
        // ç§»é™¤å…¨åŸŸç›£è½å™¨
        document.removeEventListener('mousemove', handleMouseMove);
        document.removeEventListener('mouseup', handleMouseUp);
        
        // æ¢å¾©è¦–è¦ºæ•ˆæœ
        draggedElement.classList.remove('dragging');
        const container = document.querySelector('.layout-container-enhanced');
        if (container) container.classList.remove('edit-mode');
        const gridOverlay = document.getElementById('grid-overlay');
        if (gridOverlay) gridOverlay.classList.remove('snap-mode');
        
        // ç²å–æœ€çµ‚ä½ç½®
        const finalX = parseFloat(draggedElement.style.left);
        const finalY = parseFloat(draggedElement.style.top);
        
        console.log('âœ… æ‹–æ‹½å®Œæˆ:', { id: draggedElement.dataset.id, x: finalX, y: finalY });
        
        // æ›´æ–°è³‡æ–™
        const type = draggedElement.dataset.type;
        const id = draggedElement.dataset.id;
        
        if (type === 'sensor') {
            const sensor = sensors.find(s => s.id === id);
            if (sensor) {
                sensor.x = finalX;
                sensor.y = finalY;
                console.log('ğŸ“Š å·²æ›´æ–°æ„Ÿæ¸¬å™¨ä½ç½®:', sensor);
            }
        } else if (type === 'device') {
            const device = devices.find(d => d.id === id);
            if (device) {
                device.x = finalX;
                device.y = finalY;
                console.log('ğŸ“Š å·²æ›´æ–°è¨­å‚™ä½ç½®:', device);
            }
        }
        
        // é‡ç½®ç‹€æ…‹
        isDragging = false;
        draggedElement = null;
    }
    
    function addItem(type) {
        const name = prompt(`è«‹è¼¸å…¥${type === 'sensor' ? 'æ„Ÿæ¸¬å™¨' : 'è¨­å‚™'}åç¨±:`);
        if (!name) return;
        
        const itemType = prompt(`è«‹è¼¸å…¥${type === 'sensor' ? 'æ„Ÿæ¸¬å™¨' : 'è¨­å‚™'}é¡å‹:`);
        if (!itemType) return;
        
        const deviceName = prompt(`è«‹è¼¸å…¥ MQTT è¨­å‚™åç¨± (ç”¨æ–¼ device/è¨­å‚™åç¨±/# ä¸»é¡Œ):`);
        if (!deviceName) return;
        
        const item = {
            id: Date.now().toString(),
            name: name,
            type: itemType,
            x: 50,
            y: 50,
            deviceName: deviceName,
            status: 'offline'
        };
        
        if (type === 'sensor') {
            sensors.push(item);
        } else {
            devices.push(item);
        }
        
        // é‡æ–°æ¸²æŸ“
        renderItems();
    }
    
    function renderItems() {
        const sensorsContainer = document.getElementById('sensors-container');
        const devicesContainer = document.getElementById('devices-container');
        
        sensorsContainer.innerHTML = '';
        devicesContainer.innerHTML = '';
        
        sensors.forEach(sensor => {
            const marker = document.createElement('div');
            marker.className = 'sensor-marker';
            marker.style.position = 'absolute';
            marker.style.left = sensor.x + '%';
            marker.style.top = sensor.y + '%';
            marker.dataset.type = 'sensor';
            marker.dataset.id = sensor.id;
            marker.dataset.sensorType = sensor.type;
            // å„ªå…ˆä½¿ç”¨ description ä½œç‚ºæ„Ÿæ¸¬å™¨è­˜åˆ¥åç¨±ï¼Œå¦‚æœæ²’æœ‰å‰‡ä½¿ç”¨ name
            const displayName = sensor.description || sensor.name;
            marker.title = displayName;
            
            // å–å¾—æ„Ÿæ¸¬å™¨åœ–ç¤º
            const icon = getSensorIcon(sensor.type);
            const statusClass = sensor.status === 'online' ? 'text-success' : 'text-secondary';
            
            // å»ºç«‹æ„Ÿæ¸¬å™¨æ¨™è¨˜ HTML
            let markerHTML = '<div class="sensor-display">' +
                '<div class="sensor-icon">' +
                    '<i class="' + icon + ' ' + statusClass + '"></i>' +
                '</div>' +
                '<div class="sensor-name">' + displayName + '</div>';
            
            // é¡¯ç¤ºæœ€æ–°æ•¸å€¼
            if (sensor.lastValue && sensor.lastValue.currentValues) {
                markerHTML += '<div class="sensor-values">';
                sensor.lastValue.currentValues.forEach(value => {
                    markerHTML += '<div class="sensor-value">' +
                        '<span class="value">' + value.value + '</span>' +
                        '<span class="unit">' + value.unit + '</span>' +
                    '</div>';
                });
                markerHTML += '</div>';
            }
            
            markerHTML += '</div>';
            marker.innerHTML = markerHTML;
            sensorsContainer.appendChild(marker);
        });
        
        devices.forEach(device => {
            const marker = document.createElement('div');
            marker.className = 'device-marker';
            marker.style.position = 'absolute';
            marker.style.left = device.x + '%';
            marker.style.top = device.y + '%';
            marker.dataset.type = 'device';
            marker.dataset.id = device.id;
            marker.title = device.name;
            marker.innerHTML = '<i class="fas fa-fan text-warning"></i>';
            devicesContainer.appendChild(marker);
        });
        
        if (editMode) {
            enableDragging();
        }
    }
    
    function saveLayout() {
        console.log('ğŸ’¾ é–‹å§‹å„²å­˜ä½ˆå±€è³‡æ–™:', {
            farmId: farmId,
            sensorsCount: sensors.length,
            devicesCount: devices.length,
            url: `/farms/${farmId}/sensors-devices`
        });
        
        fetch(`/farms/${farmId}/sensors-devices`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                sensors: sensors,
                devices: devices
            })
        })
        .then(response => {
            console.log('ğŸ“¨ æ”¶åˆ°ä½ˆå±€å„²å­˜å›æ‡‰:', response.status, response.statusText);
            return response.json();
        })
        .then(data => {
            console.log('ğŸ“„ å›æ‡‰è³‡æ–™:', data);
            if (data.success) {
                console.log('âœ… ä½ˆå±€å„²å­˜æˆåŠŸ');
                alert('ä½ˆå±€å·²å„²å­˜ï¼');
                location.reload();
            } else {
                console.log('âŒ ä½ˆå±€å„²å­˜å¤±æ•—:', data.error);
                alert('å„²å­˜å¤±æ•—ï¼š' + (data.error || 'æœªçŸ¥éŒ¯èª¤'));
            }
        })
        .catch(error => {
            console.error('âŒ ä½ˆå±€å„²å­˜éŒ¯èª¤:', error);
            alert('å„²å­˜å¤±æ•—ï¼Œè«‹é‡è©¦ã€‚éŒ¯èª¤ï¼š' + error.message);
        });
    }
    
    // å–å¾—æ„Ÿæ¸¬å™¨åœ–ç¤º
    function getSensorIcon(sensorType) {
        const iconMap = {
            'temperature': 'fas fa-thermometer-half',
            'humidity': 'fas fa-tint',
            'co2': 'fas fa-smog',
            'pressure': 'fas fa-gauge-high',
            'wind': 'fas fa-wind',
            'water': 'fas fa-droplet',
            'sensor': 'fas fa-microchip',
            'unknown': 'fas fa-question-circle'
        };
        return iconMap[sensorType] || iconMap['sensor'];
    }
    
    // å®šæœŸæ›´æ–°æ„Ÿæ¸¬å™¨æ•¸å€¼
    function startSensorDataRefresh() {
        setInterval(async () => {
            try {
                const response = await fetch(`/api/farms/${farmId}/sensors`);
                if (response.ok) {
                    const sensorData = await response.json();
                    updateSensorData(sensorData);
                }
            } catch (error) {
                console.error('æ›´æ–°æ„Ÿæ¸¬å™¨è³‡æ–™å¤±æ•—:', error);
            }
        }, 10000); // æ¯10ç§’æ›´æ–°ä¸€æ¬¡
    }
    
    // æ›´æ–°æ„Ÿæ¸¬å™¨è³‡æ–™
    function updateSensorData(sensorData) {
        sensorData.forEach(updatedSensor => {
            const existingSensor = sensors.find(s => s.deviceName === updatedSensor.deviceName);
            if (existingSensor) {
                existingSensor.lastValue = updatedSensor.lastValue;
                existingSensor.status = updatedSensor.status;
            }
        });
        renderItems();
    }
    
    // ç¸®æ”¾åŠŸèƒ½
    let currentZoom = 1;
    const maxZoom = 3;
    const minZoom = 0.5;
    const zoomStep = 0.2;
    
    function initializeZoomControls() {
        const zoomInBtn = document.getElementById('zoom-in-btn');
        const zoomOutBtn = document.getElementById('zoom-out-btn');
        const zoomResetBtn = document.getElementById('zoom-reset-btn');
        const layoutImage = document.getElementById('layout-image');
        
        if (zoomInBtn && zoomOutBtn && zoomResetBtn && layoutImage) {
            zoomInBtn.addEventListener('click', () => {
                currentZoom = Math.min(currentZoom + zoomStep, maxZoom);
                applyZoom();
            });
            
            zoomOutBtn.addEventListener('click', () => {
                currentZoom = Math.max(currentZoom - zoomStep, minZoom);
                applyZoom();
            });
            
            zoomResetBtn.addEventListener('click', () => {
                currentZoom = 1;
                applyZoom();
            });
            
            // æ»‘é¼ æ»¾è¼ªç¸®æ”¾
            layoutImage.addEventListener('wheel', (e) => {
                e.preventDefault();
                const delta = e.deltaY > 0 ? -zoomStep : zoomStep;
                currentZoom = Math.min(Math.max(currentZoom + delta, minZoom), maxZoom);
                applyZoom();
            });
        }
    }
    
    function applyZoom() {
        const layoutImage = document.getElementById('layout-image');
        if (layoutImage) {
            layoutImage.style.transform = `scale(${currentZoom})`;
            
            // æ›´æ–°æŒ‰éˆ•ç‹€æ…‹
            const zoomInBtn = document.getElementById('zoom-in-btn');
            const zoomOutBtn = document.getElementById('zoom-out-btn');
            
            if (zoomInBtn) zoomInBtn.disabled = currentZoom >= maxZoom;
            if (zoomOutBtn) zoomOutBtn.disabled = currentZoom <= minZoom;
        }
    }
    
    // å•Ÿå‹•é é¢æ™‚é–‹å§‹å®šæœŸæ›´æ–°
    startSensorDataRefresh();
    
    // åˆå§‹åŒ–ç¸®æ”¾åŠŸèƒ½
    initializeZoomControls();
    
    // åœ–ç‰‡ä¸Šå‚³è™•ç†
    try {
    console.log('ğŸ”§ åˆå§‹åŒ–åœ–ç‰‡ä¸Šå‚³åŠŸèƒ½...');
    const uploadForm = document.getElementById('uploadForm');
    const uploadBtn = document.getElementById('uploadBtn');
    const uploadBtnText = document.getElementById('uploadBtnText');
    const uploadingText = document.getElementById('uploadingText');
    const layoutImageInput = document.getElementById('layoutImageInput');
    
    console.log('ğŸ” å°‹æ‰¾ä¸Šå‚³å…ƒç´ :', {
        uploadForm: !!uploadForm,
        uploadBtn: !!uploadBtn,
        uploadBtnText: !!uploadBtnText,
        uploadingText: !!uploadingText,
        layoutImageInput: !!layoutImageInput
    });
    
    if (uploadForm && uploadBtn) {
        console.log('âœ… ä¸Šå‚³å…ƒç´ æ‰¾åˆ°ï¼Œè¨­å®šäº‹ä»¶ç›£è½å™¨');
        
        // æŒ‰éˆ•é»æ“Šè§¸ç™¼ä¸Šå‚³
        uploadBtn.addEventListener('click', function(e) {
            console.log('ğŸ–±ï¸ ä¸Šå‚³æŒ‰éˆ•è¢«é»æ“Šï¼');
            e.preventDefault();
            handleUpload();
        });
        
        // è¡¨å–®æäº¤ä¹Ÿè§¸ç™¼ä¸Šå‚³
        uploadForm.addEventListener('submit', function(e) {
            e.preventDefault();
            handleUpload();
        });
        
        function handleUpload() {
            console.log('ğŸ–¼ï¸ é–‹å§‹ä¸Šå‚³å ´åŸŸåœ–ç‰‡');
            
            // æª¢æŸ¥æª”æ¡ˆ
            const file = layoutImageInput.files[0];
            if (!file) {
                alert('è«‹é¸æ“‡è¦ä¸Šå‚³çš„åœ–ç‰‡æª”æ¡ˆ');
                e.preventDefault();
                return false;
            }
            
            // æª¢æŸ¥æª”æ¡ˆå¤§å° (5MB = 5 * 1024 * 1024 bytes)
            if (file.size > 5 * 1024 * 1024) {
                alert('æª”æ¡ˆå¤§å°ä¸èƒ½è¶…é 5MB');
                e.preventDefault();
                return false;
            }
            
            // æª¢æŸ¥æª”æ¡ˆé¡å‹
            if (!file.type.startsWith('image/')) {
                alert('è«‹é¸æ“‡æœ‰æ•ˆçš„åœ–ç‰‡æª”æ¡ˆ (JPG, PNG, GIF)');
                e.preventDefault();
                return false;
            }
            
            console.log('âœ… æª”æ¡ˆé©—è­‰é€šéï¼Œé–‹å§‹ä¸Šå‚³:', {
                name: file.name,
                size: file.size,
                type: file.type,
                action: uploadForm.action
            });
            
            // é¡¯ç¤ºä¸Šå‚³ç‹€æ…‹
            uploadBtn.disabled = true;
            uploadBtnText.classList.add('d-none');
            uploadingText.classList.remove('d-none');
            
            // ä½¿ç”¨ fetch API é€²è¡Œä¸Šå‚³ä»¥ç²å¾—æ›´å¥½çš„éŒ¯èª¤è™•ç†
            
            const formData = new FormData();
            formData.append('layout_image', file);
            
            console.log('ğŸ“¤ ä½¿ç”¨ fetch ä¸Šå‚³æª”æ¡ˆ...');
            
            fetch(uploadForm.action, {
                method: 'POST',
                body: formData
            })
            .then(response => {
                console.log('ğŸ“¨ æ”¶åˆ°å›æ‡‰:', response.status, response.statusText);
                if (response.ok) {
                    console.log('âœ… ä¸Šå‚³æˆåŠŸï¼Œé‡æ–°è¼‰å…¥é é¢');
                    window.location.reload();
                } else {
                    return response.text().then(text => {
                        throw new Error(`HTTP ${response.status}: ${text}`);
                    });
                }
            })
            .catch(error => {
                console.error('âŒ ä¸Šå‚³å¤±æ•—:', error);
                alert('ä¸Šå‚³å¤±æ•—: ' + error.message);
                
                // æ¢å¾©æŒ‰éˆ•ç‹€æ…‹
                uploadBtn.disabled = false;
                uploadBtnText.classList.remove('d-none');
                uploadingText.classList.add('d-none');
            });
        }
        
        // æª”æ¡ˆé¸æ“‡é è¦½
        layoutImageInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file && file.type.startsWith('image/')) {
                console.log('ğŸ“· é¸æ“‡äº†åœ–ç‰‡æª”æ¡ˆ:', file.name);
                
                // ç§»é™¤èˆŠçš„é è¦½
                const oldPreview = document.getElementById('upload-preview');
                if (oldPreview) {
                    oldPreview.remove();
                }
                
                // å‰µå»ºæ–°é è¦½
                const reader = new FileReader();
                reader.onload = function(e) {
                    const preview = document.createElement('img');
                    preview.id = 'upload-preview';
                    preview.src = e.target.result;
                    preview.className = 'img-fluid mt-2 border rounded';
                    preview.style.maxHeight = '200px';
                    preview.style.maxWidth = '100%';
                    
                    layoutImageInput.parentNode.insertAdjacentElement('afterend', preview);
                };
                reader.readAsDataURL(file);
            }
        });
    } else {
        console.log('âŒ æ‰¾ä¸åˆ°ä¸Šå‚³è¡¨å–®å…ƒç´ ï¼Œç„¡æ³•è¨­å®šä¸Šå‚³åŠŸèƒ½');
    }
} catch (error) {
    console.error('âŒ åˆå§‹åŒ–ä¸Šå‚³åŠŸèƒ½æ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
}

// åˆå§‹åŒ–æ„Ÿæ¸¬å™¨è³‡æ–™é¡¯ç¤ºå’Œè‡ªå‹•æ›´æ–°
try {
    console.log('ğŸ”§ åˆå§‹åŒ–æ„Ÿæ¸¬å™¨è³‡æ–™é¡¯ç¤º...');
    renderItems();
    startSensorDataRefresh();
    console.log('âœ… æ„Ÿæ¸¬å™¨è³‡æ–™è‡ªå‹•æ›´æ–°å·²å•Ÿå‹•');
} catch (error) {
    console.error('âŒ åˆå§‹åŒ–æ„Ÿæ¸¬å™¨åŠŸèƒ½æ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
}
});
</script>
