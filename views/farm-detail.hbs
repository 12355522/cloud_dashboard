<div class="row">
    <!-- åŸºæœ¬è³‡è¨Š -->
    <div class="col-lg-6 mb-4">
        <div class="card h-100">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="fas fa-info-circle me-2"></i>åŸºæœ¬è³‡è¨Š</h5>
                <a href="/farms/{{farm._id}}/edit" class="btn btn-sm btn-outline-primary">
                    <i class="fas fa-edit me-1"></i>ç·¨è¼¯
                </a>
            </div>
            <div class="card-body">
                <p><strong>IP ä½å€:</strong> {{farm.ip}}</p>
                <p><strong>ç‹€æ…‹:</strong> <span class="badge {{statusBadge farm.status}}">{{farm.status}}</span></p>
                <p><strong>å»ºç«‹æ™‚é–“:</strong> {{formatDate farm.created_at}}</p>
                <p><strong>æœ€å¾Œæ›´æ–°:</strong> {{formatDate farm.updated_at}}</p>
            </div>
        </div>
    </div>

    <!-- å³æ™‚å½±åƒè¼ªæ’­ (æ–°) -->
    <div class="col-lg-6 mb-4">
        <div class="card h-100">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-sync-alt me-2"></i>å³æ™‚å½±åƒè¼ªæ’­</h5>
            </div>
            <div class="card-body p-0 d-flex align-items-center justify-content-center">
                <div id="camera-carousel-container" style="width: 100%; height: 100%;">
                    <!-- è¼ªæ’­å…ƒä»¶å°‡æ’å…¥æ­¤è™• -->
                </div>
            </div>
        </div>
    </div>
</div>


<div class="row">
    <!-- å ´åŸŸä½ˆå±€ -->
    <div class="col-lg-12 mb-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-image me-2"></i>å ´åŸŸä½ˆå±€åœ–
                </h5>
            </div>
            <div class="card-body p-0">
                {{#if farm.layout_image}}
                <!-- ä½ˆå±€åœ–å¤–æ¡† -->
                <div class="layout-wrapper">
                    <div class="layout-container-enhanced">
                        <div class="layout-image-container">
                            <img id="layout-image" src="/uploads/{{farm.layout_image}}" alt="å ´åŸŸä½ˆå±€åœ–">
                            
                            <!-- æ„Ÿæ¸¬å™¨æ¨™è¨˜å®¹å™¨ï¼ˆç”±JavaScriptå‹•æ…‹ç”Ÿæˆï¼‰ -->
                            <div id="sensors-container" class="markers-layer">
                                <!-- æ„Ÿæ¸¬å™¨æ¨™è¨˜å°‡ç”±JavaScriptå‹•æ…‹ç”Ÿæˆ -->
                            </div>
                            
                            <!-- è¨­å‚™æ¨™è¨˜å®¹å™¨ï¼ˆç”±JavaScriptå‹•æ…‹ç”Ÿæˆï¼‰ -->
                            <div id="devices-container" class="markers-layer">
                                <!-- è¨­å‚™æ¨™è¨˜å°‡ç”±JavaScriptå‹•æ…‹ç”Ÿæˆ -->
                            </div>
                            
                            <!-- æ ¼ç·šèƒŒæ™¯ -->
                            <div class="grid-overlay" id="grid-overlay"></div>
                        </div>
                        

                    </div>
                </div>
                
                <!-- å·¥å…·åˆ— -->
                <div class="layout-toolbar">
                    <div class="d-flex justify-content-between align-items-center">
                        <div class="btn-group" role="group">
                            <button type="button" class="btn btn-outline-primary" id="edit-mode-btn">
                                <i class="fas fa-edit me-1"></i>ç·¨è¼¯æ¨¡å¼
                            </button>
                            <button type="button" class="btn btn-outline-success" id="add-sensor-btn" disabled>
                                <i class="fas fa-plus me-1"></i>æ–°å¢æ„Ÿæ¸¬å™¨
                            </button>
                            <button type="button" class="btn btn-outline-warning" id="add-device-btn" disabled>
                                <i class="fas fa-plus me-1"></i>æ–°å¢è¨­å‚™
                            </button>
                        </div>
                        <div class="d-flex align-items-center">
                            <button type="button" class="btn btn-success me-3" id="save-layout-btn" style="display: none;">
                                <i class="fas fa-save me-1"></i>å„²å­˜ä½ˆå±€
                            </button>
                            <span class="text-muted small" id="layout-info">
                                <i class="fas fa-info-circle me-1"></i>é»æ“Šç·¨è¼¯æ¨¡å¼é–‹å§‹é…ç½®è¨­å‚™ä½ç½®
                            </span>
                        </div>
                    </div>
                </div>
                {{else}}
                <div class="text-center py-5">
                    <i class="fas fa-upload fa-3x text-muted mb-3"></i>
                    <h5 class="text-muted">å°šæœªä¸Šå‚³å ´åŸŸä½ˆå±€åœ–</h5>
                    <p class="text-muted">è«‹ä¸Šå‚³å ´åŸŸçš„å¹³é¢åœ–ä»¥ä¾¿é€²è¡Œè¨­å‚™å’Œæ„Ÿæ¸¬å™¨çš„é…ç½®</p>
                </div>
                {{/if}}
                
                <!-- ä¸Šå‚³æ–°åœ–ç‰‡ -->
                <form action="/farms/{{farm._id}}/upload-layout" method="post" enctype="multipart/form-data" class="mt-3" id="uploadForm">
                    <div class="input-group">
                        <input type="file" class="form-control" name="layout_image" accept="image/*" required id="layoutImageInput">
                        <button type="button" class="btn btn-primary" id="uploadBtn">
                            <span id="uploadBtnText">
                                <i class="fas fa-upload me-1"></i>{{#if farm.layout_image}}æ›´æ›åœ–ç‰‡{{else}}ä¸Šå‚³åœ–ç‰‡{{/if}}
                            </span>
                            <span id="uploadingText" class="d-none">
                                <i class="fas fa-spinner fa-spin me-1"></i>ä¸Šå‚³ä¸­...
                            </span>
                        </button>
                    </div>
                    <div class="form-text">æ”¯æ´æ ¼å¼ï¼šJPG, PNG, GIF (æœ€å¤§ 5MB)</div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- æ”å½±æ©Ÿè¼ªæ’­è¨­å®š (æ–°) -->
<div class="row">
    <div class="col-12 mb-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-video me-2"></i>æ”å½±æ©Ÿè¼ªæ’­è¨­å®š</h5>
            </div>
            <div class="card-body">
                <div id="carousel-settings-container">
                    <p class="text-muted">æ­£åœ¨è¼‰å…¥åˆ†é…è‡³æ­¤å ´åŸŸçš„æ”å½±æ©Ÿ...</p>
                </div>
            </div>
            <div class="card-footer text-end">
                <button id="save-carousel-btn" class="btn btn-primary" disabled>
                    <i class="fas fa-save me-1"></i> å„²å­˜è¼ªæ’­è¨­å®š
                </button>
            </div>
        </div>
    </div>
</div>


<!-- WebSocket å’Œæ„Ÿæ¸¬å™¨/è¨­å‚™äº’å‹•çš„ JavaScript -->
<script src="/socket.io/socket.io.js"></script>
<script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
<script>
// 2D ä½ˆå±€ç·¨è¼¯åŠŸèƒ½
document.addEventListener('DOMContentLoaded', function() {
    const farmId = '{{farm._id}}';
    let editMode = false;
    let sensors = {{{json farm.sensors}}};
    let devices = {{{json farm.devices}}};
    
    // å°‡ sensors è¨­ç‚ºå…¨åŸŸè®Šæ•¸ï¼Œä¾›å…¶ä»–å‡½æ•¸ä½¿ç”¨
    window.farmSensors = sensors;
    window.farmDevices = devices;
    
    const editModeBtn = document.getElementById('edit-mode-btn');
    const addSensorBtn = document.getElementById('add-sensor-btn');
    const addDeviceBtn = document.getElementById('add-device-btn');
    const saveLayoutBtn = document.getElementById('save-layout-btn');
    const layoutImage = document.getElementById('layout-image');

    const style = document.createElement('style');
    style.innerHTML = `
        .dragging {
            cursor: grabbing !important;
            z-index: 1000;
            pointer-events: none;
        }
    `;
    document.head.appendChild(style);
    
    if (editModeBtn) {
        editModeBtn.addEventListener('click', toggleEditMode);
    }
    
    if (addSensorBtn) {
        addSensorBtn.addEventListener('click', () => addItem('sensor'));
    }
    
    if (addDeviceBtn) {
        addDeviceBtn.addEventListener('click', () => addItem('device'));
    }
    
    if (saveLayoutBtn) {
        saveLayoutBtn.addEventListener('click', saveLayout);
    }
    
    function toggleEditMode() {
        editMode = !editMode;
        const gridOverlay = document.getElementById('grid-overlay');
        const layoutInfo = document.getElementById('layout-info');
        
        if (editMode) {
            editModeBtn.innerHTML = '<i class="fas fa-times me-1"></i>é€€å‡ºç·¨è¼¯';
            editModeBtn.className = 'btn btn-danger';
            addSensorBtn.disabled = false;
            addDeviceBtn.disabled = false;
            saveLayoutBtn.style.display = 'inline-block';
            if(layoutImage) layoutImage.style.cursor = 'crosshair';
            if (gridOverlay) gridOverlay.classList.remove('show');
            if (layoutInfo) {
                layoutInfo.innerHTML = '<i class="fas fa-edit me-1"></i>ç·¨è¼¯æ¨¡å¼ï¼šæ‹–å‹•è¨­å‚™èª¿æ•´ä½ç½®';
                layoutInfo.style.background = 'rgba(40, 167, 69, 0.1)';
                layoutInfo.style.borderColor = 'rgba(40, 167, 69, 0.2)';
            }
            enableDragging();
        } else {
            editModeBtn.innerHTML = '<i class="fas fa-edit me-1"></i>ç·¨è¼¯æ¨¡å¼';
            editModeBtn.className = 'btn btn-outline-primary';
            addSensorBtn.disabled = true;
            addDeviceBtn.disabled = true;
            saveLayoutBtn.style.display = 'none';
            if(layoutImage) layoutImage.style.cursor = 'default';
            if (gridOverlay) gridOverlay.classList.add('show');
            if (layoutInfo) {
                layoutInfo.innerHTML = '<i class="fas fa-info-circle me-1"></i>é»æ“Šç·¨è¼¯æ¨¡å¼é–‹å§‹é…ç½®è¨­å‚™ä½ç½®';
                layoutInfo.style.background = 'rgba(13, 110, 253, 0.1)';
                layoutInfo.style.borderColor = 'rgba(13, 110, 253, 0.2)';
            }
            disableDragging();
        }
    }
    
    function enableDragging() {
        const markers = document.querySelectorAll('.sensor-marker, .device-marker');
        markers.forEach(marker => {
            marker.style.cursor = 'move';
            setupMouseDrag(marker);
        });
    }
    
    function disableDragging() {
        const markers = document.querySelectorAll('.sensor-marker, .device-marker');
        markers.forEach(marker => {
            marker.style.cursor = 'default';
            removeMouseDrag(marker);
        });
    }

    // --- FINAL DRAG LOGIC (Directly manipulating left/top for debugging) ---
    // This version removes `transform` entirely to test if it's the cause of CSS conflicts or perceived lag.
    let draggedElement = null;
    let dragContext = null; 

    function setupMouseDrag(element) {
        element.addEventListener('mousedown', onDragStart, { passive: false });
    }

    function removeMouseDrag(element) {
        element.removeEventListener('mousedown', onDragStart);
    }

    function onDragStart(e) {
        if (!editMode || e.button !== 0 || !layoutImage) return;

        e.preventDefault();
        
        draggedElement = e.currentTarget;
        const imageRect = layoutImage.getBoundingClientRect();
        
        dragContext = {
            imageRect: imageRect,
            initialMouseX: e.clientX,
            initialMouseY: e.clientY,
            initialLeftPercent: parseFloat(draggedElement.style.left),
            initialTopPercent: parseFloat(draggedElement.style.top)
        };

        document.addEventListener('mousemove', onDragMove, { passive: false });
        document.addEventListener('mouseup', onDragEnd, { once: true });

        draggedElement.classList.add('dragging');
    }

    function onDragMove(e) {
        e.preventDefault();
        if (!draggedElement || !dragContext) return;

        const imageRect = dragContext.imageRect;
        const deltaX = e.clientX - dragContext.initialMouseX;
        const deltaY = e.clientY - dragContext.initialMouseY;

        const deltaXPercent = (deltaX / imageRect.width) * 100;
        const deltaYPercent = (deltaY / imageRect.height) * 100;

        let newXPercent = dragContext.initialLeftPercent + deltaXPercent;
        let newYPercent = dragContext.initialTopPercent + deltaYPercent;

        // Clamp values to stay within the image boundaries
        newXPercent = Math.max(0, Math.min(100, newXPercent));
        newYPercent = Math.max(0, Math.min(100, newYPercent));
        
        // Directly update left and top properties
        draggedElement.style.left = newXPercent + '%';
        draggedElement.style.top = newYPercent + '%';
    }

    function onDragEnd(e) {
        if (!dragContext) {
            draggedElement = null;
            return;
        };
        document.removeEventListener('mousemove', onDragMove);
        
        if (!draggedElement) return;

        // The element is already at its final position from the last onDragMove event
        const finalXPercent = parseFloat(draggedElement.style.left);
        const finalYPercent = parseFloat(draggedElement.style.top);

        draggedElement.classList.remove('dragging');

        console.log('âœ… æ‹–æ‹½å®Œæˆ:', { id: draggedElement.dataset.id, x: finalXPercent, y: finalYPercent });
        
        const type = draggedElement.dataset.type;
        const id = draggedElement.dataset.id;
        
        const collection = type === 'sensor' ? sensors : devices;
        const item = collection.find(i => i.id === id);
        if (item) {
            item.x = finalXPercent;
            item.y = finalYPercent;
            console.log(`ğŸ“Š å·²æ›´æ–°${type}ä½ç½®:`, item);
        }
        
        draggedElement = null;
        dragContext = null;
    }
    // --- END OF FINAL DRAG LOGIC ---
    
    function addItem(type) {
        const name = prompt(`è«‹è¼¸å…¥${type === 'sensor' ? 'æ„Ÿæ¸¬å™¨' : 'è¨­å‚™'}åç¨±:`);
        if (!name) return;
        
        const itemType = prompt(`è«‹è¼¸å…¥${type === 'sensor' ? 'æ„Ÿæ¸¬å™¨' : 'è¨­å‚™'}é¡å‹:`);
        if (!itemType) return;
        
        const deviceName = prompt(`è«‹è¼¸å…¥ MQTT è¨­å‚™åç¨± (ç”¨æ–¼ device/è¨­å‚™åç¨±/# ä¸»é¡Œ):`);
        if (!deviceName) return;
        
        const item = {
            id: Date.now().toString(),
            name: name,
            type: itemType,
            x: 50,
            y: 50,
            deviceName: deviceName,
            status: 'offline'
        };
        
        if (type === 'sensor') {
            sensors.push(item);
        } else {
            devices.push(item);
        }
        
        renderItems();
    }
    
    function renderItems() {
        const sensorsContainer = document.getElementById('sensors-container');
        const devicesContainer = document.getElementById('devices-container');
        
        if (!sensorsContainer || !devicesContainer) return;

        sensorsContainer.innerHTML = '';
        devicesContainer.innerHTML = '';
        
        sensors.forEach(sensor => {
            const marker = document.createElement('div');
            marker.className = 'sensor-marker';
            marker.style.position = 'absolute';
            marker.style.left = sensor.x + '%';
            marker.style.top = sensor.y + '%';
            marker.dataset.type = 'sensor';
            marker.dataset.id = sensor.id;
            marker.dataset.sensorType = sensor.type;
            
            // å„ªå…ˆä½¿ç”¨ description ä½œç‚ºæ„Ÿæ¸¬å™¨è­˜åˆ¥åç¨±ï¼Œå¦‚æœæ²’æœ‰å‰‡ä½¿ç”¨ name
            const displayName = sensor.description || sensor.name;
            marker.title = displayName;
            
            // ä½¿ç”¨èˆ‡ dashboard ä¸€è‡´çš„æ„Ÿæ¸¬å™¨å¡ç‰‡æ¨£å¼
            const isActive = sensor.lastValue && sensor.lastValue.currentValues;
            const statusClass = isActive ? 'active' : 'inactive';
            
            let markerHTML = '<div class="sensor-card ' + statusClass + '">' +
                '<div class="sensor-info">' +
                    '<div class="sensor-name">' + displayName + '</div>';
            
            // é¡¯ç¤ºæ„Ÿæ¸¬å™¨æ•¸å€¼ï¼ˆå¦‚æœæœ‰ï¼‰
            if (isActive) {
                markerHTML += '<div class="sensor-values">';
                sensor.lastValue.currentValues.forEach(value => {
                    markerHTML += '<div class="sensor-value-inline">' +
                        '<span class="value">' + value.value + '</span>' +
                        '<span class="unit">' + value.unit + '</span>' +
                    '</div>';
                });
                markerHTML += '</div>';
                
                // æª¢æŸ¥æ„Ÿæ¸¬å™¨æ•¸å€¼æ˜¯å¦ç•°å¸¸ä¸¦æ‡‰ç”¨è­¦å ±æ¨£å¼
                setTimeout(() => {
                    const sensorCard = marker.querySelector('.sensor-card');
                    if (sensorCard && window.sensorAlertSystem) {
                        // æª¢æŸ¥æ¯å€‹æ•¸å€¼
                        sensor.lastValue.currentValues.forEach(value => {
                            const alertInfo = window.sensorAlertSystem.checkSensorValue(sensor.id, sensor.type, value.value, value.unit);
                            if (alertInfo.isAbnormal) {
                                window.sensorAlertSystem.applyAlertStyle(sensorCard, alertInfo);
                            }
                        });
                    }
                }, 100);
            } else {
                // é¡¯ç¤ºé›¢ç·šç‹€æ…‹
                markerHTML += '<div class="sensor-status">é›¢ç·š</div>';
            }
            
            markerHTML += '</div></div>';
            marker.innerHTML = markerHTML;
            sensorsContainer.appendChild(marker);
        });
        
        devices.forEach(device => {
            const marker = document.createElement('div');
            marker.className = 'device-marker';
            marker.style.position = 'absolute';
            marker.style.left = device.x + '%';
            marker.style.top = device.y + '%';
            marker.dataset.type = 'device';
            marker.dataset.id = device.id;
            marker.title = device.name;
            marker.innerHTML = '<i class="fas fa-fan text-warning"></i>';
            devicesContainer.appendChild(marker);
        });
        
        if (editMode) {
            enableDragging();
        }
    }
    
    function saveLayout() {
        console.log('ğŸ’¾ é–‹å§‹å„²å­˜ä½ˆå±€è³‡æ–™:', {
            farmId: farmId,
            sensorsCount: sensors.length,
            devicesCount: devices.length,
            url: `/farms/${farmId}/sensors-devices`
        });
        
        fetch(`/farms/${farmId}/sensors-devices`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                sensors: sensors,
                devices: devices
            })
        })
        .then(response => {
            console.log('ğŸ“¨ æ”¶åˆ°ä½ˆå±€å„²å­˜å›æ‡‰:', response.status, response.statusText);
            return response.json();
        })
        .then(data => {
            console.log('ğŸ“„ å›æ‡‰è³‡æ–™:', data);
            if (data.success) {
                console.log('âœ… ä½ˆå±€å„²å­˜æˆåŠŸ');
                alert('ä½ˆå±€å·²å„²å­˜ï¼');
                location.reload();
            } else {
                console.log('âŒ ä½ˆå±€å„²å­˜å¤±æ•—:', data.error);
                alert('å„²å­˜å¤±æ•—ï¼š' + (data.error || 'æœªçŸ¥éŒ¯èª¤'));
            }
        })
        .catch(error => {
            console.error('âŒ ä½ˆå±€å„²å­˜éŒ¯èª¤:', error);
            alert('å„²å­˜å¤±æ•—ï¼Œè«‹é‡è©¦ã€‚éŒ¯èª¤ï¼š' + error.message);
        });
    }
    
    function getSensorIcon(sensorType) {
        const iconMap = {
            'temperature': 'fas fa-thermometer-half',
            'humidity': 'fas fa-tint',
            'co2': 'fas fa-smog',
            'pressure': 'fas fa-gauge-high',
            'wind': 'fas fa-wind',
            'water': 'fas fa-droplet',
            'sensor': 'fas fa-microchip',
            'unknown': 'fas fa-question-circle'
        };
        return iconMap[sensorType] || iconMap['sensor'];
    }
    
    function startSensorDataRefresh() {
        setInterval(async () => {
            try {
                const response = await fetch(`/api/farms/${farmId}/sensors`);
                if (response.ok) {
                    const sensorData = await response.json();
                    updateSensorData(sensorData);
                }
            } catch (error) {
                console.error('æ›´æ–°æ„Ÿæ¸¬å™¨è³‡æ–™å¤±æ•—:', error);
            }
        }, 10000);
    }
    
    function updateSensorData(sensorData) {
        sensorData.forEach(updatedSensor => {
            const existingSensor = sensors.find(s => s.deviceName === updatedSensor.deviceName);
            if (existingSensor) {
                existingSensor.lastValue = updatedSensor.lastValue;
                existingSensor.status = updatedSensor.status;
                
                // åŒæ­¥æ›´æ–°å…¨åŸŸ sensors è³‡æ–™
                const globalSensor = window.farmSensors ? window.farmSensors.find(s => s.deviceName === updatedSensor.deviceName) : null;
                if (globalSensor) {
                    globalSensor.lastValue = updatedSensor.lastValue;
                    globalSensor.status = updatedSensor.status;
                }
                
                // æ›´æ–°æ„Ÿæ¸¬å™¨åˆ—è¡¨ä¸­çš„æ•¸æ“šä¸¦æª¢æŸ¥è­¦å ±
                updateSensorListItem(existingSensor);
            }
        });
        renderItems();
    }
    
    // (updateSensorListItem å‡½æ•¸å·²ç§»åˆ°å…¨åŸŸä½œç”¨åŸŸ)
    
    try {
        console.log('ğŸ”§ åˆå§‹åŒ–åœ–ç‰‡ä¸Šå‚³åŠŸèƒ½...');
        const uploadForm = document.getElementById('uploadForm');
        const uploadBtn = document.getElementById('uploadBtn');
        const uploadBtnText = document.getElementById('uploadBtnText');
        const uploadingText = document.getElementById('uploadingText');
        const layoutImageInput = document.getElementById('layoutImageInput');
        
        if (uploadForm && uploadBtn) {
            uploadBtn.addEventListener('click', function(e) {
                e.preventDefault();
                handleUpload();
            });
            
            uploadForm.addEventListener('submit', function(e) {
                e.preventDefault();
                handleUpload();
            });
            
            function handleUpload() {
                const file = layoutImageInput.files[0];
                if (!file) {
                    alert('è«‹é¸æ“‡è¦ä¸Šå‚³çš„åœ–ç‰‡æª”æ¡ˆ');
                    return;
                }
                if (file.size > 5 * 1024 * 1024) {
                    alert('æª”æ¡ˆå¤§å°ä¸èƒ½è¶…é 5MB');
                    return;
                }
                if (!file.type.startsWith('image/')) {
                    alert('è«‹é¸æ“‡æœ‰æ•ˆçš„åœ–ç‰‡æª”æ¡ˆ (JPG, PNG, GIF)');
                    return;
                }
                
                uploadBtn.disabled = true;
                uploadBtnText.classList.add('d-none');
                uploadingText.classList.remove('d-none');
                
                const formData = new FormData();
                formData.append('layout_image', file);
                
                fetch(uploadForm.action, {
                    method: 'POST',
                    body: formData
                })
                .then(response => {
                    if (response.ok) {
                        window.location.reload();
                    } else {
                        return response.text().then(text => { throw new Error(`HTTP ${response.status}: ${text}`); });
                    }
                })
                .catch(error => {
                    console.error('âŒ ä¸Šå‚³å¤±æ•—:', error);
                    alert('ä¸Šå‚³å¤±æ•—: ' + error.message);
                    uploadBtn.disabled = false;
                    uploadBtnText.classList.remove('d-none');
                    uploadingText.classList.add('d-none');
                });
            }
            
            layoutImageInput.addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file && file.type.startsWith('image/')) {
                    const oldPreview = document.getElementById('upload-preview');
                    if (oldPreview) oldPreview.remove();
                    
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const preview = document.createElement('img');
                        preview.id = 'upload-preview';
                        preview.src = e.target.result;
                        preview.className = 'img-fluid mt-2 border rounded';
                        preview.style.maxHeight = '200px';
                        preview.style.maxWidth = '100%';
                        layoutImageInput.parentNode.insertAdjacentElement('afterend', preview);
                    };
                    reader.readAsDataURL(file);
                }
            });
        }
    } catch (error) {
        console.error('âŒ åˆå§‹åŒ–ä¸Šå‚³åŠŸèƒ½æ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
    }
    
    try {
        console.log('ğŸ”§ åˆå§‹åŒ–æ„Ÿæ¸¬å™¨è³‡æ–™é¡¯ç¤º...');
        renderItems();
        
        // åˆå§‹åŒ–æ„Ÿæ¸¬å™¨åˆ—è¡¨çš„è­¦å ±æª¢æ¸¬
        initializeSensorListAlerts();
        
        startSensorDataRefresh();
        console.log('âœ… æ„Ÿæ¸¬å™¨è³‡æ–™è‡ªå‹•æ›´æ–°å·²å•Ÿå‹•');
    } catch (error) {
        console.error('âŒ åˆå§‹åŒ–æ„Ÿæ¸¬å™¨åŠŸèƒ½æ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
    }
    
    // åˆå§‹åŒ–æ„Ÿæ¸¬å™¨åˆ—è¡¨çš„è­¦å ±æª¢æ¸¬
    function initializeSensorListAlerts() {
        // åˆå§‹åŒ–æ„Ÿæ¸¬å™¨åœ–ç¤º
        initializeSensorIcons();
        
        // ç­‰å¾…è­¦å ±ç³»çµ±è¼‰å…¥
        setTimeout(() => {
            if (window.sensorAlertSystem) {
                console.log('ğŸ”” åˆå§‹åŒ–æ„Ÿæ¸¬å™¨åˆ—è¡¨è­¦å ±æª¢æ¸¬...');
                sensors.forEach(sensor => {
                    if (sensor.lastValue && sensor.lastValue.currentValues) {
                        updateSensorListItem(sensor);
                    }
                });
                console.log('âœ… æ„Ÿæ¸¬å™¨åˆ—è¡¨è­¦å ±æª¢æ¸¬å·²å•Ÿå‹•');
            } else {
                console.warn('âš ï¸ è­¦å ±ç³»çµ±æœªè¼‰å…¥ï¼Œè·³éè­¦å ±æª¢æ¸¬åˆå§‹åŒ–');
            }
        }, 1000);
    }
    
    // åˆå§‹åŒ–æ„Ÿæ¸¬å™¨åœ–ç¤º
    function initializeSensorIcons() {
        document.querySelectorAll('.sensor-list-item').forEach(item => {
            const sensorType = item.dataset.sensorType;
            const sensorId = item.dataset.sensorId;
            const icon = item.querySelector('i');
            if (icon && sensorType) {
                const iconClass = getSensorIcon(sensorType);
                icon.className = iconClass + ' me-2 text-primary';
            }
            
            // æª¢æŸ¥æ˜¯å¦æœ‰å€‹åˆ¥é…ç½®ä¸¦æ·»åŠ è¦–è¦ºæŒ‡ç¤ºå™¨
            if (window.sensorAlertSystem && sensorId) {
                const hasIndividualConfig = window.sensorAlertSystem.getIndividualSensorConfig(sensorId);
                const configBtn = item.querySelector('.sensor-config-controls .btn');
                if (configBtn) {
                    if (hasIndividualConfig) {
                        configBtn.classList.add('has-individual-config');
                        configBtn.title = 'å·²è¨­å®šå€‹åˆ¥è­¦å ±é…ç½®';
                    } else {
                        configBtn.classList.remove('has-individual-config');
                        configBtn.title = 'è¨­å®šå€‹åˆ¥è­¦å ±';
                    }
                }
            }
        });
    }
});

// æ›´æ–°æ„Ÿæ¸¬å™¨åˆ—è¡¨é …ç›®ï¼ˆå…¨åŸŸå‡½æ•¸ï¼‰
function updateSensorListItem(sensor) {
    const listItem = document.querySelector(`[data-sensor-id="${sensor.id}"]`);
    if (!listItem) return;
    
    const valuesContainer = listItem.querySelector('.sensor-values-container');
    const alertIndicator = listItem.querySelector('.alert-status-indicator');
    
    // æ¸…é™¤èˆŠçš„è­¦å ±æ¨£å¼
    listItem.classList.remove('alert-warning', 'alert-danger', 'alert-critical');
    
    if (sensor.lastValue && sensor.lastValue.currentValues) {
        // æ›´æ–°æ•¸å€¼é¡¯ç¤º
        const valuesList = valuesContainer.querySelector('.sensor-values-list') || 
                          valuesContainer.appendChild(document.createElement('div'));
        valuesList.className = 'sensor-values-list';
        valuesList.innerHTML = '';
        
        let highestAlertLevel = 'normal';
        
        // æª¢æŸ¥æ¯å€‹æ•¸å€¼ä¸¦æ‡‰ç”¨è­¦å ±æ¨£å¼
        sensor.lastValue.currentValues.forEach(value => {
            const valueBadge = document.createElement('div');
            valueBadge.className = 'sensor-value-badge';
            valueBadge.setAttribute('data-value', value.value);
            valueBadge.setAttribute('data-unit', value.unit);
            
            // æª¢æŸ¥è­¦å ±ç‹€æ…‹
            if (window.sensorAlertSystem) {
                const alertInfo = window.sensorAlertSystem.checkSensorValue(sensor.id, sensor.type, value.value, value.unit);
                if (alertInfo.isAbnormal) {
                    valueBadge.classList.add(alertInfo.level);
                    if (alertInfo.level === 'critical') {
                        highestAlertLevel = 'critical';
                    } else if (alertInfo.level === 'danger' && highestAlertLevel !== 'critical') {
                        highestAlertLevel = 'danger';
                    } else if (alertInfo.level === 'warning' && highestAlertLevel === 'normal') {
                        highestAlertLevel = 'warning';
                    }
                }
            }
            
            valueBadge.innerHTML = `
                <span class="value">${value.value}</span>
                <span class="unit">${value.unit}</span>
            `;
            valuesList.appendChild(valueBadge);
        });
        
        // æ‡‰ç”¨åˆ—è¡¨é …ç›®çš„è­¦å ±æ¨£å¼
        if (highestAlertLevel !== 'normal') {
            listItem.classList.add(`alert-${highestAlertLevel}`);
            
            // é¡¯ç¤ºè­¦å ±æŒ‡ç¤ºå™¨
            alertIndicator.style.display = 'flex';
            const alertBadge = alertIndicator.querySelector('.alert-level-badge') || 
                              alertIndicator.appendChild(document.createElement('div'));
            alertBadge.className = `alert-level-badge ${highestAlertLevel}`;
            alertBadge.textContent = highestAlertLevel.toUpperCase();
            
            // æ’­æ”¾è­¦å ±è²ï¼ˆåƒ…é™æœ€é«˜ç­‰ç´šï¼‰
            if (window.sensorAlertSystem && highestAlertLevel === 'critical') {
                window.sensorAlertSystem.playAlertSound(highestAlertLevel);
            }
        } else {
            alertIndicator.style.display = 'none';
        }
        
        // æ›´æ–°æ™‚é–“æˆ³
        const timestampElement = valuesContainer.querySelector('.text-muted') || 
                               valuesContainer.appendChild(document.createElement('small'));
        timestampElement.className = 'text-muted d-block mt-1';
        timestampElement.textContent = `æ›´æ–°æ™‚é–“: ${new Date(sensor.lastValue.timestamp).toLocaleString('zh-TW')}`;
        
        // éš±è—é›¢ç·šç‹€æ…‹
        const offlineStatus = valuesContainer.querySelector('.sensor-offline-status');
        if (offlineStatus) {
            offlineStatus.style.display = 'none';
        }
        
    } else {
        // é¡¯ç¤ºé›¢ç·šç‹€æ…‹
        valuesContainer.innerHTML = `
            <div class="sensor-offline-status">
                <span class="badge bg-secondary">é›¢ç·š</span>
                <small class="text-muted ms-2">ç„¡æœ€æ–°æ•¸æ“š</small>
            </div>
        `;
        alertIndicator.style.display = 'none';
    }
}

// å€‹åˆ¥æ„Ÿæ¸¬å™¨é…ç½®åŠŸèƒ½
function openSensorConfigModal(sensorId, description, name, type) {
    const modal = document.getElementById('sensorConfigModal');
    const form = document.getElementById('sensorConfigForm');
    
    // è¨­ç½®æ¨¡æ…‹æ¨™é¡Œ
    document.getElementById('sensorConfigTitle').textContent = `è¨­å®šæ„Ÿæ¸¬å™¨è­¦å ±ï¼š${description || name}`;
    document.getElementById('configSensorId').value = sensorId;
    document.getElementById('configSensorType').value = type;
    
    // æª¢æŸ¥æ„Ÿæ¸¬å™¨çš„æ•¸å€¼é¡å‹
    const sensor = window.farmSensors ? window.farmSensors.find(s => s.id === sensorId) : null;
    let valueTypes = [];
    
    if (sensor && sensor.lastValue && sensor.lastValue.currentValues) {
        valueTypes = sensor.lastValue.currentValues.map(value => {
            return {
                type: window.sensorAlertSystem?.getValueTypeByUnit(value.unit) || 'unknown',
                unit: value.unit,
                value: value.value
            };
        });
    }
    
    // è¼‰å…¥ç¾æœ‰é…ç½®
    loadMultiValueSensorConfig(sensorId, type, valueTypes);
    
    // é¡¯ç¤ºæ¨¡æ…‹
    const bsModal = new bootstrap.Modal(modal);
    bsModal.show();
}

function loadMultiValueSensorConfig(sensorId, sensorType, valueTypes) {
    if (!window.sensorAlertSystem) return;
    
    const configContainer = document.getElementById('multiValueConfigContainer');
    configContainer.innerHTML = '';
    
    if (valueTypes.length <= 1) {
        // å–®ä¸€æ•¸å€¼é¡å‹ï¼Œä½¿ç”¨åŸæœ‰çš„é…ç½®æ–¹å¼
        loadSingleValueConfig(sensorId, sensorType, valueTypes[0]);
    } else {
        // å¤šæ•¸å€¼é¡å‹ï¼Œç‚ºæ¯å€‹æ•¸å€¼é¡å‹å‰µå»ºé…ç½®å€åŸŸ
        valueTypes.forEach((valueInfo, index) => {
            createValueTypeConfigSection(sensorId, valueInfo, index);
        });
    }
}

function loadSingleValueConfig(sensorId, sensorType, valueInfo) {
    const valueType = valueInfo ? valueInfo.type : sensorType;
    
    // ç²å–é…ç½®
    let config = window.sensorAlertSystem.getIndividualSensorValueConfig(sensorId, valueType);
    
    if (!config) {
        const defaultConfig = window.sensorAlertSystem.getAlertConfig();
        config = defaultConfig[valueType] || {
            normal: { min: 0, max: 100 },
            warning: { offset: 5 },
            danger: { offset: 10 },
            critical: { offset: 20 }
        };
    }
    
    // å‰µå»ºå–®ä¸€é…ç½®å€åŸŸ
    const configContainer = document.getElementById('multiValueConfigContainer');
    configContainer.innerHTML = `
        <div class="single-value-config" data-value-type="${valueType}">
            <h6>${valueInfo ? `${getValueTypeName(valueType)} (${valueInfo.unit})` : sensorType}</h6>
            
            <div class="alert alert-info mb-3">
                <small><i class="fas fa-info-circle me-1"></i>
                è¨­å®šæ­£å¸¸ç¯„åœï¼Œç„¶å¾Œè¨­å®šè¶…å‡ºæ­£å¸¸ç¯„åœå¤šå°‘æ™‚è§¸ç™¼è­¦å ±</small>
            </div>
            
            <div class="row mb-4">
                <div class="col-12">
                    <label class="form-label fw-bold">æ­£å¸¸ç¯„åœ</label>
                    <div class="input-group">
                        <input type="number" class="form-control normal-min" value="${config.normal?.min || 0}" step="0.1">
                        <span class="input-group-text">è‡³</span>
                        <input type="number" class="form-control normal-max" value="${config.normal?.max || 100}" step="0.1">
                        <span class="input-group-text">${valueInfo?.unit || ''}</span>
                    </div>
                </div>
            </div>
            
            <div class="row mb-3">
                <div class="col-md-4">
                    <label class="form-label text-warning">è­¦å‘Šåå·®</label>
                    <div class="input-group">
                        <span class="input-group-text">Â±</span>
                        <input type="number" class="form-control warning-offset" value="${config.warning?.offset || 5}" step="0.1" min="0">
                        <span class="input-group-text">${valueInfo?.unit || ''}</span>
                    </div>
                    <small class="text-muted">è¶…å‡ºæ­£å¸¸ç¯„åœæ­¤æ•¸å€¼æ™‚è­¦å‘Š</small>
                </div>
                <div class="col-md-4">
                    <label class="form-label text-danger">å±éšªåå·®</label>
                    <div class="input-group">
                        <span class="input-group-text">Â±</span>
                        <input type="number" class="form-control danger-offset" value="${config.danger?.offset || 10}" step="0.1" min="0">
                        <span class="input-group-text">${valueInfo?.unit || ''}</span>
                    </div>
                    <small class="text-muted">è¶…å‡ºæ­£å¸¸ç¯„åœæ­¤æ•¸å€¼æ™‚å±éšª</small>
                </div>
                <div class="col-md-4">
                    <label class="form-label" style="color: #dc3545;">è‡¨ç•Œåå·®</label>
                    <div class="input-group">
                        <span class="input-group-text">Â±</span>
                        <input type="number" class="form-control critical-offset" value="${config.critical?.offset || 20}" step="0.1" min="0">
                        <span class="input-group-text">${valueInfo?.unit || ''}</span>
                    </div>
                    <small class="text-muted">è¶…å‡ºæ­£å¸¸ç¯„åœæ­¤æ•¸å€¼æ™‚è‡¨ç•Œ</small>
                </div>
            </div>
        </div>
    `;
}

function createValueTypeConfigSection(sensorId, valueInfo, index) {
    const { type, unit, value } = valueInfo;
    
    // ç²å–è©²æ•¸å€¼é¡å‹çš„é…ç½®
    let config = window.sensorAlertSystem.getIndividualSensorValueConfig(sensorId, type);
    
    if (!config) {
        const defaultConfig = window.sensorAlertSystem.getAlertConfig();
        config = defaultConfig[type] || {
            normal: { min: 0, max: 100 },
            warning: { offset: 5 },
            danger: { offset: 10 },
            critical: { offset: 20 }
        };
    }
    
    const configContainer = document.getElementById('multiValueConfigContainer');
    const sectionHTML = `
        <div class="value-type-config mb-4" data-value-type="${type}">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h6 class="mb-0">${getValueTypeName(type)} (${unit})</h6>
                <small class="text-muted">ç›®å‰æ•¸å€¼: ${value} ${unit}</small>
            </div>
            
            <div class="alert alert-info mb-3">
                <small><i class="fas fa-info-circle me-1"></i>
                è¨­å®šæ­£å¸¸ç¯„åœï¼Œç„¶å¾Œè¨­å®šè¶…å‡ºæ­£å¸¸ç¯„åœå¤šå°‘æ™‚è§¸ç™¼è­¦å ±</small>
            </div>
            
            <div class="row mb-4">
                <div class="col-12">
                    <label class="form-label fw-bold">æ­£å¸¸ç¯„åœ</label>
                    <div class="input-group">
                        <input type="number" class="form-control normal-min" value="${config.normal?.min || 0}" step="0.1">
                        <span class="input-group-text">è‡³</span>
                        <input type="number" class="form-control normal-max" value="${config.normal?.max || 100}" step="0.1">
                        <span class="input-group-text">${unit}</span>
                    </div>
                </div>
            </div>
            
            <div class="row mb-3">
                <div class="col-md-4">
                    <label class="form-label text-warning">è­¦å‘Šåå·®</label>
                    <div class="input-group">
                        <span class="input-group-text">Â±</span>
                        <input type="number" class="form-control warning-offset" value="${config.warning?.offset || 5}" step="0.1" min="0">
                        <span class="input-group-text">${unit}</span>
                    </div>
                    <small class="text-muted">è¶…å‡ºæ­£å¸¸ç¯„åœæ­¤æ•¸å€¼æ™‚è­¦å‘Š</small>
                </div>
                <div class="col-md-4">
                    <label class="form-label text-danger">å±éšªåå·®</label>
                    <div class="input-group">
                        <span class="input-group-text">Â±</span>
                        <input type="number" class="form-control danger-offset" value="${config.danger?.offset || 10}" step="0.1" min="0">
                        <span class="input-group-text">${unit}</span>
                    </div>
                    <small class="text-muted">è¶…å‡ºæ­£å¸¸ç¯„åœæ­¤æ•¸å€¼æ™‚å±éšª</small>
                </div>
                <div class="col-md-4">
                    <label class="form-label" style="color: #dc3545;">è‡¨ç•Œåå·®</label>
                    <div class="input-group">
                        <span class="input-group-text">Â±</span>
                        <input type="number" class="form-control critical-offset" value="${config.critical?.offset || 20}" step="0.1" min="0">
                        <span class="input-group-text">${unit}</span>
                    </div>
                    <small class="text-muted">è¶…å‡ºæ­£å¸¸ç¯„åœæ­¤æ•¸å€¼æ™‚è‡¨ç•Œ</small>
                </div>
            </div>
        </div>
    `;
    
    configContainer.insertAdjacentHTML('beforeend', sectionHTML);
}

function getValueTypeName(type) {
    const names = {
        temperature: 'æº«åº¦',
        humidity: 'æ¿•åº¦',
        co2: 'CO2æ¿ƒåº¦',
        pressure: 'æ°£å£“',
        wind: 'é¢¨é€Ÿ',
        water: 'æ°´é‡',
        light: 'å…‰ç…§',
        ph: 'pHå€¼',
        noise: 'å™ªéŸ³',
        unknown: 'æœªçŸ¥'
    };
    
    return names[type] || type;
}

function saveSensorConfig() {
    const sensorId = document.getElementById('configSensorId').value;
    const configSections = document.querySelectorAll('#multiValueConfigContainer .value-type-config, #multiValueConfigContainer .single-value-config');
    
    let hasAnyConfig = false;
    
    configSections.forEach(section => {
        const valueType = section.dataset.valueType;
        
        const config = {
            normal: {
                min: parseFloat(section.querySelector('.normal-min').value),
                max: parseFloat(section.querySelector('.normal-max').value)
            },
            warning: {
                offset: parseFloat(section.querySelector('.warning-offset').value)
            },
            danger: {
                offset: parseFloat(section.querySelector('.danger-offset').value)
            },
            critical: {
                offset: parseFloat(section.querySelector('.critical-offset').value)
            }
        };
        
        // é©—è­‰é…ç½®
        if (!validateSensorValueConfig(config, valueType)) {
            return;
        }
        
        // å„²å­˜è©²æ•¸å€¼é¡å‹çš„é…ç½®
        if (window.sensorAlertSystem) {
            window.sensorAlertSystem.setIndividualSensorValueConfig(sensorId, valueType, config);
            hasAnyConfig = true;
        }
    });
    
    if (hasAnyConfig) {
        // é‡æ–°æª¢æŸ¥è©²æ„Ÿæ¸¬å™¨çš„è­¦å ±ç‹€æ…‹
        const sensor = window.farmSensors ? window.farmSensors.find(s => s.id === sensorId) : null;
        if (sensor && sensor.lastValue && sensor.lastValue.currentValues) {
            updateSensorListItem(sensor);
        }
        
        // æ›´æ–°é…ç½®æŒ‡ç¤ºå™¨
        updateConfigIndicator(sensorId, true);
        
        alert('æ„Ÿæ¸¬å™¨è­¦å ±é…ç½®å·²å„²å­˜ï¼');
        
        // é—œé–‰æ¨¡æ…‹
        const modal = bootstrap.Modal.getInstance(document.getElementById('sensorConfigModal'));
        modal.hide();
    }
}

function resetToDefaultConfig() {
    const sensorId = document.getElementById('configSensorId').value;
    const sensorType = document.getElementById('configSensorType').value;
    
    // æª¢æŸ¥æ„Ÿæ¸¬å™¨çš„æ•¸å€¼é¡å‹
    const sensor = window.farmSensors ? window.farmSensors.find(s => s.id === sensorId) : null;
    let valueTypes = [];
    
    if (sensor && sensor.lastValue && sensor.lastValue.currentValues) {
        valueTypes = sensor.lastValue.currentValues.map(value => {
            return {
                type: window.sensorAlertSystem?.getValueTypeByUnit(value.unit) || 'unknown',
                unit: value.unit,
                value: value.value
            };
        });
    }
    
    // é‡æ–°è¼‰å…¥é è¨­é…ç½®
    loadMultiValueSensorConfig(null, sensorType, valueTypes);
}

function removeIndividualConfig() {
    const sensorId = document.getElementById('configSensorId').value;
    
    if (confirm('ç¢ºå®šè¦åˆªé™¤æ­¤æ„Ÿæ¸¬å™¨çš„å€‹åˆ¥é…ç½®ï¼Œä¸¦ä½¿ç”¨é¡å‹é è¨­é…ç½®å—ï¼Ÿ')) {
        if (window.sensorAlertSystem) {
            window.sensorAlertSystem.removeIndividualSensorConfig(sensorId);
            
            // é‡æ–°æª¢æŸ¥è©²æ„Ÿæ¸¬å™¨çš„è­¦å ±ç‹€æ…‹
            const sensor = window.farmSensors ? window.farmSensors.find(s => s.id === sensorId) : null;
            if (sensor && sensor.lastValue && sensor.lastValue.currentValues) {
                updateSensorListItem(sensor);
            }
            
            // æ›´æ–°é…ç½®æŒ‡ç¤ºå™¨
            updateConfigIndicator(sensorId, false);
            
            alert('å€‹åˆ¥é…ç½®å·²åˆªé™¤ï¼');
            
            // é—œé–‰æ¨¡æ…‹
            const modal = bootstrap.Modal.getInstance(document.getElementById('sensorConfigModal'));
            modal.hide();
        }
    }
}

function validateSensorValueConfig(config, valueType) {
    const typeName = getValueTypeName(valueType);
    
    // æª¢æŸ¥æ­£å¸¸ç¯„åœ
    if (config.normal.min >= config.normal.max) {
        alert(`${typeName} æ­£å¸¸ç¯„åœè¨­å®šéŒ¯èª¤ï¼šæœ€å°å€¼å¿…é ˆå°æ–¼æœ€å¤§å€¼`);
        return false;
    }
    
    // æª¢æŸ¥åå·®å€¼å¿…é ˆç‚ºæ­£æ•¸
    if (config.warning.offset < 0) {
        alert(`${typeName} è­¦å‘Šåå·®ä¸èƒ½ç‚ºè² æ•¸`);
        return false;
    }
    
    if (config.danger.offset < 0) {
        alert(`${typeName} å±éšªåå·®ä¸èƒ½ç‚ºè² æ•¸`);
        return false;
    }
    
    if (config.critical.offset < 0) {
        alert(`${typeName} è‡¨ç•Œåå·®ä¸èƒ½ç‚ºè² æ•¸`);
        return false;
    }
    
    // æª¢æŸ¥åå·®éå¢é—œä¿‚
    if (config.warning.offset >= config.danger.offset) {
        alert(`${typeName} å±éšªåå·®å¿…é ˆå¤§æ–¼è­¦å‘Šåå·®`);
        return false;
    }
    
    if (config.danger.offset >= config.critical.offset) {
        alert(`${typeName} è‡¨ç•Œåå·®å¿…é ˆå¤§æ–¼å±éšªåå·®`);
        return false;
    }
    
    return true;
}

function updateConfigIndicator(sensorId, hasConfig) {
    const listItem = document.querySelector(`[data-sensor-id="${sensorId}"]`);
    if (listItem) {
        const configBtn = listItem.querySelector('.sensor-config-controls .btn');
        if (configBtn) {
            if (hasConfig) {
                configBtn.classList.add('has-individual-config');
                configBtn.title = 'å·²è¨­å®šå€‹åˆ¥è­¦å ±é…ç½®';
            } else {
                configBtn.classList.remove('has-individual-config');
                configBtn.title = 'è¨­å®šå€‹åˆ¥è­¦å ±';
            }
        }
    }
}

// å­˜æ ¹å‡½æ•¸ï¼šç‚ºäº†èˆ‡å…¶ä»–é é¢çš„å…¼å®¹æ€§è€Œæä¾›çš„ç©ºå¯¦ç¾
function adjustOverlayToImage(img) {
    console.log('Farm Detail: adjustOverlayToImage è¢«èª¿ç”¨ï¼Œä½†åœ¨æ­¤é é¢ä¸åŸ·è¡Œä»»ä½•æ“ä½œ');
}

document.addEventListener('DOMContentLoaded', function () {
    const farmId = '{{farm._id}}';
    const carouselContainer = document.getElementById('camera-carousel-container');
    const settingsContainer = document.getElementById('carousel-settings-container');
    const saveBtn = document.getElementById('save-carousel-btn');
    
    let carouselPlayers = [];

    const api = {
        get: (url) => fetch(url).then(res => res.json()),
        post: (url, body) => fetch(url, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(body)
        }).then(res => res.json())
    };

    const loadCarouselSettings = async () => {
        try {
            const res = await api.get(`/api/farms/${farmId}/cameras`);
            if (!res.success) {
                settingsContainer.innerHTML = '<p class="text-danger">ç„¡æ³•è¼‰å…¥æ”å½±æ©Ÿåˆ—è¡¨ã€‚</p>';
                return;
            }

            const assignedCameras = res.cameras;
            const selectedCameras = {{{json farm.carouselCameras}}};

            if (assignedCameras.length === 0) {
                settingsContainer.innerHTML = '<p class="text-muted">æ²’æœ‰åˆ†é…çµ¦æ­¤å ´åŸŸçš„æ”å½±æ©Ÿã€‚è«‹å…ˆè‡³<a href="/onvif-cameras">æ”å½±æ©Ÿç®¡ç†é é¢</a>é€²è¡Œåˆ†é…ã€‚</p>';
                return;
            }

            let checkboxesHTML = '<p>è«‹é¸æ“‡æœ€å¤šå…©éš»æ”å½±æ©Ÿä»¥åœ¨ä¸Šæ–¹é€²è¡Œè¼ªæ’­é¡¯ç¤ºï¼š</p>';
            assignedCameras.forEach(cam => {
                const isChecked = selectedCameras.includes(cam.ip);
                checkboxesHTML += `
                    <div class="form-check">
                        <input class="form-check-input carousel-cam-checkbox" type="checkbox" value="${cam.ip}" id="cam-${cam.ip.replace(/\./g, '-')}" ${isChecked ? 'checked' : ''}>
                        <label class="form-check-label" for="cam-${cam.ip.replace(/\./g, '-')}">
                            ${cam.hostname || cam.ip}
                        </label>
                    </div>
                `;
            });
            settingsContainer.innerHTML = checkboxesHTML;
            saveBtn.disabled = false;

            // ç¶å®š checkbox é™åˆ¶é¸æ“‡æ•¸é‡çš„äº‹ä»¶
            const checkboxes = document.querySelectorAll('.carousel-cam-checkbox');
            checkboxes.forEach(checkbox => {
                checkbox.addEventListener('change', () => {
                    const checkedCount = document.querySelectorAll('.carousel-cam-checkbox:checked').length;
                    if (checkedCount > 2) {
                        showToast('warning', 'æœ€å¤šåªèƒ½é¸æ“‡å…©éš»æ”å½±æ©Ÿé€²è¡Œè¼ªæ’­ã€‚');
                        checkbox.checked = false;
                    }
                });
            });
        } catch (e) {
            settingsContainer.innerHTML = '<p class="text-danger">è¼‰å…¥æ”å½±æ©Ÿåˆ—è¡¨æ™‚ç™¼ç”ŸéŒ¯èª¤ã€‚</p>';
        }
    };

    const saveCarouselSettings = async () => {
        const selectedIps = Array.from(document.querySelectorAll('.carousel-cam-checkbox:checked')).map(cb => cb.value);
        
        try {
            const res = await api.post(`/api/farms/${farmId}/carousel-cameras`, { cameraIps: selectedIps });
            if (res.success) {
                showToast('success', res.message);
                // é‡æ–°è¼‰å…¥é é¢ä»¥æ‡‰ç”¨æ–°çš„è¼ªæ’­è¨­å®š
                location.reload();
            } else {
                showToast('error', `å„²å­˜å¤±æ•—: ${res.error}`);
            }
        } catch (e) {
            showToast('error', 'å„²å­˜è¨­å®šæ™‚ç™¼ç”Ÿç¶²è·¯éŒ¯èª¤');
        }
    };

    const loadAndRenderCarousel = async () => {
        carouselContainer.innerHTML = '<div class="d-flex justify-content-center align-items-center h-100"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div></div>';
        
        const selectedCameras = {{{json farm.carouselCameras}}};
        if (!selectedCameras || selectedCameras.length === 0) {
             carouselContainer.innerHTML = '<div class="text-muted d-flex justify-content-center align-items-center h-100 p-3">æ­¤å ´åŸŸå°šæœªè¨­å®šè¼ªæ’­æ”å½±æ©Ÿã€‚</div>';
             return;
        }

        carouselContainer.innerHTML = `
            <div id="farmCameraCarousel" class="carousel slide h-100" data-bs-ride="carousel">
                <div class="carousel-inner h-100">
                    ${selectedCameras.map((ip, index) => `
                        <div class="carousel-item h-100 ${index === 0 ? 'active' : ''}">
                            <video id="carousel-video-${ip.replace(/\./g, '-')}" class="d-block w-100 h-100" style="object-fit: cover; background-color: #000;" controls muted autoplay></video>
                            <div class="carousel-caption d-none d-md-block bg-dark bg-opacity-50 rounded px-2 py-1">
                                <h5 class="mb-0">${ip}</h5>
                            </div>
                        </div>
                    `).join('')}
                </div>
                ${selectedCameras.length > 1 ? `
                <button class="carousel-control-prev" type="button" data-bs-target="#farmCameraCarousel" data-bs-slide="prev">
                    <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                    <span class="visually-hidden">Previous</span>
                </button>
                <button class="carousel-control-next" type="button" data-bs-target="#farmCameraCarousel" data-bs-slide="next">
                    <span class="carousel-control-next-icon" aria-hidden="true"></span>
                    <span class="visually-hidden">Next</span>
                </button>
                ` : ''}
            </div>
        `;
        
        // å•Ÿå‹•ä¸²æµä¸¦æ’­æ”¾
        startCarouselStreams(selectedCameras);
    };

    const startCarouselStreams = (ips) => {
        // å…ˆåœæ­¢èˆŠçš„æ’­æ”¾å™¨
        carouselPlayers.forEach(player => {
            api.post(`/api/onvif/stream/stop/${player.ip}`);
            if (player.hls) player.hls.destroy();
        });
        carouselPlayers = [];

        ips.forEach(async (ip) => {
            const videoEl = document.getElementById(`carousel-video-${ip.replace(/\./g, '-')}`);
            if (!videoEl) return;

            try {
                const res = await api.post(`/api/onvif/stream/start/${ip}`);
                if (res.success) {
                    const hls = new Hls();
                    hls.loadSource(res.stream.playlistUrl);
                    hls.attachMedia(videoEl);
                    carouselPlayers.push({ ip, hls });
                } else {
                    console.error(`ç„¡æ³•å•Ÿå‹•è¼ªæ’­æ”å½±æ©Ÿ ${ip} çš„ä¸²æµ`);
                }
            } catch (e) {
                 console.error(`å•Ÿå‹•è¼ªæ’­ä¸²æµ ${ip} å¤±æ•—:`, e);
            }
        });
    };
    
    // é é¢é›¢é–‹æ™‚åœæ­¢æ‰€æœ‰ä¸²æµ
    window.addEventListener('beforeunload', () => {
        carouselPlayers.forEach(player => {
            api.post(`/api/onvif/stream/stop/${player.ip}`);
        });
    });

    saveBtn.addEventListener('click', saveCarouselSettings);

    // åˆå§‹åŒ–
    loadCarouselSettings();
    loadAndRenderCarousel();
});

function showToast(type, message) {
    const toastContainer = document.getElementById('toast-container'); // å‡è¨­æ‚¨æœ‰é€™å€‹å®¹å™¨
    if (!toastContainer) {
        console.error('Toast container not found!');
        return;
    }

    const toast = document.createElement('div');
    const icon = type === 'success' ? 'fa-check-circle' : type === 'error' ? 'fa-times-circle' : 'fa-info-circle';
    toast.className = `alert alert-${type === 'error' ? 'danger' : type} alert-dismissible fade show`;
    toast.innerHTML = `<i class="fas ${icon} me-2"></i>${message}<button type="button" class="btn-close" data-bs-dismiss="alert"></button>`;
    toastContainer.appendChild(toast);
    setTimeout(() => bootstrap.Alert.getOrCreateInstance(toast).close(), 5000);
}

</script>

<!-- å€‹åˆ¥æ„Ÿæ¸¬å™¨é…ç½®æ¨¡æ…‹å°è©±æ¡† -->
<div class="modal fade" id="sensorConfigModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="sensorConfigTitle">æ„Ÿæ¸¬å™¨è­¦å ±é…ç½®</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="sensorConfigForm">
                    <input type="hidden" id="configSensorId">
                    <input type="hidden" id="configSensorType">
                    
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        æ­¤é…ç½®åƒ…é©ç”¨æ–¼ç•¶å‰æ„Ÿæ¸¬å™¨çš„å„å€‹æ•¸å€¼é¡å‹ã€‚å¦‚æœæœªè¨­å®šå€‹åˆ¥é…ç½®ï¼Œå°‡ä½¿ç”¨æ„Ÿæ¸¬å™¨é¡å‹çš„é è¨­é…ç½®ã€‚
                    </div>
                    
                    <!-- å‹•æ…‹é…ç½®å®¹å™¨ -->
                    <div id="multiValueConfigContainer">
                        <!-- é…ç½®å€åŸŸå°‡åœ¨é€™è£¡å‹•æ…‹ç”Ÿæˆ -->
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-danger" onclick="removeIndividualConfig()">
                    <i class="fas fa-trash me-1"></i>åˆªé™¤å€‹åˆ¥é…ç½®
                </button>
                <button type="button" class="btn btn-outline-secondary" onclick="resetToDefaultConfig()">
                    <i class="fas fa-undo me-1"></i>é‡ç½®ç‚ºé è¨­
                </button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                <button type="button" class="btn btn-primary" onclick="saveSensorConfig()">
                    <i class="fas fa-save me-1"></i>å„²å­˜é…ç½®
                </button>
            </div>
        </div>
    </div>
</div>

