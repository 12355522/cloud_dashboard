# ONVIF攝影機管理系統使用說明

## 功能概述

本系統新增了完整的ONVIF攝影機管理功能，讓您可以：
- 自動搜尋網路上的ONVIF攝影機
- 手動連接指定的攝影機
- 拍攝即時快照
- 將RTSP串流轉換為HLS格式供瀏覽器播放
- 將攝影機影像加入輪播系統

## 系統架構

### 新增的檔案
- `services/onvifService.js` - ONVIF服務核心模組
- `views/onvif-cameras.hbs` - 攝影機管理頁面
- `views/carousel.hbs` - 影像輪播頁面
- `public/snapshots/` - 快照儲存目錄
- `public/streams/` - HLS串流檔案目錄

### 新增的套件
- `onvif` - ONVIF協議支援
- `fluent-ffmpeg` - 影片處理和串流轉換

## 使用方式

### 1. 攝影機管理

#### 訪問管理頁面
- 在導航欄點擊「攝影機管理」
- 或直接訪問 `http://localhost:3000/onvif-cameras`

#### 搜尋攝影機
1. 點擊「搜尋攝影機」按鈕
2. 系統會自動掃描網路上支援ONVIF的攝影機
3. 發現的攝影機會顯示在統計面板中

#### 手動新增攝影機
1. 點擊「手動新增」按鈕
2. 填入攝影機資訊：
   - IP位址（必填）
   - 連接埠（預設80）
   - 使用者名稱
   - 密碼
3. 點擊「新增攝影機」

#### 攝影機操作
每個攝影機卡片提供以下功能：
- 📷 **拍攝快照** - 立即拍攝並儲存快照
- ▶️ **開始串流** - 啟動RTSP轉HLS串流
- ⏹️ **停止串流** - 停止串流轉換
- 👁️ **檢視串流** - 在彈窗中播放即時影像
- 🔗 **斷開連接** - 移除攝影機連接

### 2. 影像輪播系統

#### 訪問輪播頁面
- 在導航欄點擊「影像輪播」
- 或直接訪問 `http://localhost:3000/carousel`

#### 新增攝影機到輪播
1. 在攝影機管理頁面啟動攝影機串流
2. 點擊「檢視串流」按鈕
3. 在串流檢視彈窗中點擊「加入輪播」
4. 攝影機影像會自動加入輪播列表

#### 輪播控制
- **播放/暫停** - 控制自動輪播
- **上一個/下一個** - 手動切換項目
- **全螢幕** - 進入全螢幕模式
- **設定** - 調整輪播參數

#### 輪播設定選項
- **切換間隔** - 每個項目顯示時間（1-300秒）
- **自動開始播放** - 頁面載入時自動開始
- **循環播放** - 播放完最後一個項目後回到第一個
- **轉場效果** - 淡入淡出、滑動或無效果

#### 項目管理
- **上移/下移** - 調整播放順序
- **刪除** - 移除單個項目
- **清空所有** - 移除所有輪播項目

### 3. 鍵盤快捷鍵（輪播頁面）
- `空白鍵` - 播放/暫停
- `←` - 上一個項目
- `→` - 下一個項目
- `Esc` - 退出全螢幕

## API 端點

### ONVIF API
- `POST /api/onvif/discover` - 搜尋攝影機
- `POST /api/onvif/connect` - 連接攝影機
- `POST /api/onvif/snapshot/:ip` - 拍攝快照
- `POST /api/onvif/stream/start/:ip` - 開始串流
- `POST /api/onvif/stream/stop/:ip` - 停止串流
- `POST /api/onvif/disconnect/:ip` - 斷開連接
- `GET /api/onvif/status` - 獲取狀態

### 輪播API
- `POST /api/carousel/add-camera` - 新增攝影機到輪播
- `POST /api/carousel/remove-item` - 移除輪播項目
- `POST /api/carousel/move-item` - 移動項目順序
- `POST /api/carousel/clear-all` - 清空所有項目
- `POST /api/carousel/settings` - 更新設定
- `GET /api/carousel/status` - 獲取輪播狀態

## 技術細節

### RTSP轉HLS串流
系統使用FFmpeg將攝影機的RTSP串流轉換為HLS格式：
- 使用TCP傳輸協議確保穩定性
- 設定低延遲模式
- 自動清理過期的串流片段

### 快照管理
- 快照儲存在 `public/snapshots/` 目錄
- 檔名格式：`snapshot_{IP}_{時間戳}.jpg`
- 系統會自動清理24小時前的快照

### 瀏覽器相容性
- 支援HLS.js播放器
- 相容現代瀏覽器（Chrome、Firefox、Safari、Edge）
- 自動偵測瀏覽器原生HLS支援

## 故障排除

### 攝影機連接失敗
1. 確認攝影機IP位址正確
2. 檢查攝影機是否支援ONVIF協議
3. 驗證使用者名稱和密碼
4. 確認網路連通性

### 串流無法播放
1. 確認FFmpeg已正確安裝
2. 檢查攝影機RTSP串流是否可用
3. 確認防火牆設定
4. 查看伺服器日誌獲取詳細錯誤資訊

### 快照拍攝失敗
1. 確認攝影機支援快照功能
2. 檢查快照URI是否正確獲取
3. 驗證攝影機認證資訊

## 系統需求

### 伺服器端
- Node.js 14+
- FFmpeg（用於串流轉換）
- 足夠的磁碟空間儲存快照和串流檔案

### 客戶端
- 現代瀏覽器
- 穩定的網路連接
- 支援JavaScript

## 安全注意事項

1. **攝影機認證** - 使用強密碼保護攝影機
2. **網路隔離** - 建議將攝影機放在獨立的VLAN中
3. **存取控制** - 限制管理介面的存取權限
4. **資料清理** - 定期清理快照和串流檔案

## 效能優化建議

1. **串流數量** - 避免同時啟動過多串流
2. **解析度設定** - 根據需求調整攝影機解析度
3. **網路頻寬** - 確保足夠的網路頻寬
4. **硬體資源** - 監控CPU和記憶體使用情況

## 未來擴展

系統設計支援以下擴展功能：
- 攝影機群組管理
- 錄影功能
- 動態偵測
- 多使用者權限管理
- 雲端儲存整合
