# 定頻風扇溫控系統使用說明

## 系統概述

此系統將原本的變頻風扇控制改為定頻風扇的溫控器形式，提供以下主要功能：

1. **基本溫控模式**：設定開啟溫度和關閉溫度
2. **間歇模式**：可設定開啟分鐘與關閉分鐘
3. **二氧化碳強制通風**：CO2濃度過高時強制啟動
4. **日程控制**：根據飼養天數自動調整參數

## 使用方法

### 1. 啟動系統

```bash
# 在專案目錄下執行
npm start
```

### 2. 訪問控制介面

打開瀏覽器，訪問以下任一網址：

- **控制介面**：`http://localhost:3000/remote/constant-fan-page?N=設備編號`
- **演示頁面**：`http://localhost:3000/demo/constant-fan?N=設備編號`

範例：
- `http://localhost:3000/remote/constant-fan-page?N=DEV001`
- `http://localhost:3000/demo/constant-fan?N=DEV001`

### 3. 基本設定

#### 溫控設定
- **開啟溫度**：當感測器溫度高於此值時，風扇開啟
- **關閉溫度**：當感測器溫度低於此值時，風扇關閉
- **注意**：開啟溫度必須高於關閉溫度，避免頻繁開關

#### 間歇模式
- 啟用間歇模式後，當溫度在開啟/關閉溫度之間時：
  - 風扇運轉指定的「開啟分鐘」
  - 然後停止指定的「關閉分鐘」
  - 如此循環運作

#### 二氧化碳控制
- 當CO2濃度超過設定值時，無視溫度設定強制啟動風扇
- 需要選擇對應的CO2感測器

### 4. 日程控制

系統支援根據飼養天數自動調整控制參數：

- **天數**：飼養的第幾天
- **開啟溫度**：該天數對應的開啟溫度
- **關閉溫度**：該天數對應的關閉溫度
- **間歇開啟**：間歇模式的開啟分鐘數
- **間歇關閉**：間歇模式的關閉分鐘數

## 測試功能

### 1. 使用測試工具

```bash
# 執行測試程式
node test-constant-fan.js
```

這個測試程式會：
- 模擬溫度感測器數據（18°C - 35°C循環變化）
- 模擬CO2感測器數據（400-1600 ppm隨機值）
- 監聽控制指令並回傳風扇狀態

### 2. 手動測試流程

1. 啟動系統：`npm start`
2. 啟動測試工具：`node test-constant-fan.js`
3. 開啟瀏覽器：`http://localhost:3000/demo/constant-fan?N=DEV001`
4. 在左側控制面板設定參數
5. 點擊「儲存設定」
6. 觀察右側狀態監控的變化

## API 接口

### 獲取設定
```
GET /remote/constant-fan?N=設備編號
```

### 儲存設定
```
POST /remote/constant-fan
Content-Type: application/json

{
  "CNumber": "設備編號",
  "deviceType": "constant_fan",
  "sensorOne": "溫度感測器編號",
  "startTemp": 28,
  "stopTemp": 25,
  "isIntermittentMode": true,
  "onMinutes": 15,
  "offMinutes": 45,
  ...
}
```

### 獲取風扇狀態
```
GET /remote/constant-fan-status?N=設備編號
```

## MQTT 訊息格式

### 控制指令（發送到設備）
主題：`device/{設備編號}/control`

```json
{
  "device": "DEV001",
  "type": "constant_fan_control",
  "settings": {
    "sensorOne": "11A001",
    "startTemp": 28,
    "stopTemp": 25,
    "isIntermittentMode": true,
    "onMinutes": 15,
    "offMinutes": 45,
    "co2Threshold": 1500,
    "isEnable": true
  },
  "timestamp": "2025-01-19T10:30:00.000Z"
}
```

### 狀態回應（設備回傳）
主題：`device/{設備編號}/status`

```json
{
  "device": "DEV001",
  "type": "fan_status_response",
  "status": {
    "isRunning": true,
    "currentTemp": 25.5,
    "mode": "temperature",
    "lastUpdate": "2025-01-19T10:30:00.000Z"
  }
}
```

## 故障排除

### 常見問題

1. **無法儲存設定**
   - 檢查是否選擇了溫度感測器
   - 確認開啟溫度高於關閉溫度
   - 檢查網路連線

2. **無法接收MQTT訊息**
   - 確認MQTT Broker正在運行
   - 檢查設備編號是否正確
   - 查看控制台日誌

3. **間歇模式不生效**
   - 確認已啟用間歇模式開關
   - 檢查開啟/關閉分鐘數設定

### 日誌檢查

系統運行時會在控制台輸出詳細日誌：

```
✅ 已發送定頻風扇控制指令到 device/DEV001/control
🌡️  當前溫度: 26.5°C
💨 CO2濃度: 850 ppm
```

## 檔案結構

```
views/
├── constant-fan.hbs          # 定頻風扇控制介面
├── constant-fan-demo.hbs     # 演示頁面（含狀態監控）
└── ...

test-constant-fan.js          # 測試工具
定頻風扇使用說明.md           # 本說明文件
```

## 技術特點

- **響應式設計**：支援手機和桌面瀏覽器
- **即時監控**：自動更新設備狀態
- **MQTT通訊**：可靠的IoT設備控制
- **參數驗證**：防止不合理的設定
- **日誌記錄**：完整的操作記錄

## 後續擴展

系統設計支援以下擴展功能：
- 歷史數據記錄
- 警報通知
- 多設備群組控制
- 自動化規則引擎

