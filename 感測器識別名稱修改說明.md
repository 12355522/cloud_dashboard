# 感測器識別名稱修改說明

## 概述

本次修改將感測器的 `description` 欄位設為主要識別名稱，讓使用者能夠更清楚地識別每個感測器的具體位置和功能。

## 修改內容

### 1. 資料庫模型修改 (`models/Farm.js`)

- 在 `sensorSchema` 中新增 `description` 欄位
- `description` 欄位設為必填，作為感測器的主要識別名稱
- `name` 欄位保留為感測器類型名稱

```javascript
const sensorSchema = new mongoose.Schema({
    id: { type: String, required: true },
    name: { type: String, required: true }, // 感測器類型名稱
    description: { type: String, required: true }, // 感測器描述作為主要識別名稱
    type: { type: String, required: true },
    // ... 其他欄位
});
```

### 2. MQTT 服務修改 (`services/mqttClient.js`)

#### 新格式感測器創建 (`createSensorFromNewFormat`)
- 創建感測器時自動設定 `description` 欄位
- 更新現有感測器時同步更新 `description` 欄位

#### 舊格式感測器創建 (`createSensorFromConfig`)
- 支援從 `DES` 欄位解碼中文描述
- 將解碼後的描述設定為 `description` 欄位

### 3. API 回應修改 (`server.js`)

- 感測器資料 API 回應中加入 `description` 欄位
- 輪播資料 API 回應中加入 `description` 欄位

### 4. 前端顯示修改

#### `views/farm-detail.hbs`
- 感測器標記優先顯示 `description` 欄位
- 如果沒有 `description`，則備用顯示 `name` 欄位
- 工具提示 (tooltip) 也使用 `description` 作為主要識別名稱
- **感測器列表顯示**: 優先顯示 `description`，備用顯示 `name`

#### `views/dashboard.hbs`
- 輪播頁面中的感測器名稱優先顯示 `description` 欄位
- 如果沒有 `description`，則備用顯示 `name` 欄位

```javascript
// 優先使用 description 作為感測器識別名稱，如果沒有則使用 name
const displayName = sensor.description || sensor.name;
marker.title = displayName;
// ...
'<div class="sensor-name">' + displayName + '</div>';
```

## 使用方式

### 1. 感測器配置資料格式

```json
{
    "device_info": {
        "device_name": "R02b5165",
        "total_sensors": 4,
        "status": "active"
    },
    "sensors": [
        {
            "device_info": {
                "serial_number": "16A0885024",
                "description": "後區溫度監測器",  // 主要識別名稱
                "address": 1,
                "name": "溫度感測器",           // 感測器類型名稱
                "status": "active"
            },
            "sensor_values": [...],
            "profile": "",
            "metadata": {...}
        }
    ]
}
```

### 2. 個別感測器數值資料格式

```json
{
    "A": 25.5,
    "timestamp": "2025-08-28T15:37:25.653Z",
    "sensorId": "16A5388982",
    "sensorName": "溫度感測器",
    "description": "後區溫度監測器",  // 主要識別名稱
    "address": 1,
    "status": "active",
    "published_by": "mqtt-push-service"
}
```

## 測試工具

### 1. 主要測試檔案
- `test-description-as-name.js` - 測試 description 作為主要識別名稱
- `test-sensor-display.js` - 測試感測器顯示邏輯修改

### 2. 測試步驟
1. 確保 MQTT Broker 正在運行
2. 執行測試檔案：`node test-description-as-name.js`
3. 檢查控制台輸出，確認 description 欄位正確顯示
4. 檢查前端頁面，確認感測器名稱顯示為 description 內容

## 資料庫遷移

### 1. 遷移腳本
- `migrate-sensor-description.js` - 為現有感測器資料添加 description 欄位

### 2. 遷移步驟
1. **備份資料庫** (重要！)
2. 執行遷移腳本：`node migrate-sensor-description.js`
3. 檢查遷移結果，確認所有感測器都有 description 欄位
4. 重新啟動應用程式

### 3. 遷移內容
- 為沒有 description 的感測器自動生成預設描述
- 根據感測器類型和名稱生成有意義的描述
- 驗證遷移結果，確保資料完整性

## 顯示優先順序

1. **第一優先**: `sensor.description` - 感測器描述（主要識別名稱）
2. **第二優先**: `sensor.name` - 感測器類型名稱（備用識別名稱）

## 注意事項

1. **資料庫遷移**: 現有感測器資料需要更新，加入 `description` 欄位
2. **向後相容**: 如果沒有 `description` 欄位，系統會自動使用 `name` 欄位
3. **中文支援**: 系統支援 UTF-8 編碼的中文描述
4. **MQTT 主題**: 個別感測器數值的主題格式保持不變
5. **欄位驗證**: `description` 欄位設為可選，預設值為空字串

## 預期效果

- 感測器在場域佈局圖中顯示更具描述性的名稱
- 使用者能夠快速識別感測器的具體位置和功能
- 系統維護和故障排除更加容易
- 感測器資料的可讀性大幅提升

## 相關檔案

- `models/Farm.js` - 資料庫模型定義
- `services/mqttClient.js` - MQTT 服務邏輯
- `server.js` - API 端點和資料處理
- `views/farm-detail.hbs` - 前端顯示邏輯
- `test-description-as-name.js` - 測試工具
